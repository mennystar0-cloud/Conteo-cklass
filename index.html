<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Conteo CKLASS – PWA con Firestore</title>
<meta name="theme-color" content="#1877F2" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png" />
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --safe-bottom: env(safe-area-inset-bottom); --safe-top: env(safe-area-inset-top); }
  video { object-fit: cover; }
  @media print { .no-print { display:none!important; } }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  #quaggaOverlay { position:absolute; inset:0; pointer-events:none; }
  #quaggaArea { position: relative; background: #000; }
  .badge { display:inline-block; padding:.1rem .4rem; border-radius:.4rem; font-size:.75rem; }
  .cam-compact { height: 45vh; max-height: 420px; }
  .btn { padding:.5rem .75rem; font-size:.875rem; border-radius:.5rem; }
  .table th, .table td { border-bottom: 1px solid #e5e7eb; padding:.25rem .5rem; }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-4">
  <header class="mb-4 no-print">
    <h1 class="text-2xl font-bold">Módulo de Conteo – PWA</h1>
    <p class="text-sm text-gray-600">Importar → Escanear → Reporte → Historial. (HTTPS/localhost para cámara)</p>
  </header>

  <!-- Tabs -->
  <div class="border-b border-gray-200 mb-4 no-print">
    <nav class="-mb-px flex gap-2" id="tabs">
      <button data-tab="importar" class="tab-btn border-b-2 border-blue-600 text-blue-600 px-4 py-2 text-sm font-medium">1) Importar</button>
      <button data-tab="escanear" class="tab-btn border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 px-4 py-2 text-sm font-medium">2) Escanear</button>
      <button data-tab="reporte" class="tab-btn border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 px-4 py-2 text-sm font-medium">3) Reporte</button>
      <button data-tab="historial" class="tab-btn border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 px-4 py-2 text-sm font-medium">4) Historial</button>
    </nav>
  </div>

  <!-- Importar -->
  <section id="tab-importar" class="tab-pane block">
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Catálogo maestro (CSV)</h2>
        <p class="text-xs text-gray-600 mb-2">Columnas: <code>CODIGO_BARRA, MOD, COLOR, TALLA, TEMPORADA</code></p>
        <input id="fileCatalogo" type="file" accept=".csv" class="block w-full text-sm mb-2" />
        <div id="catalogoStatus" class="text-xs text-gray-600">Sin cargar.</div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Existencia física (CSV)</h2>
        <p class="text-xs text-gray-600 mb-2">Formato: <code>MOD,COLOR,TALLA,CANTIDAD</code> o <code>CODIGO-COLOR-TALLA,CANTIDAD</code></p>
        <input id="fileExistenciaCSV" type="file" accept=".csv" class="block w-full text-sm mb-2" />
        <div id="existenciaCSVStatus" class="text-xs text-gray-600">Sin cargar.</div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 mt-4">
      <h3 class="font-semibold mb-2">Pegar existencia (opcional)</h3>
      <textarea id="existenciaInput" rows="5" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="Líneas: MOD,COLOR-TALLA | MOD|COLOR|TALLA | CODIGO_BARRA"></textarea>
      <div class="flex gap-2 mt-2">
        <button id="btnProcesarExistencia" class="btn bg-blue-600 text-white">Procesar</button>
        <button id="btnLimpiarExistencia" class="btn bg-gray-100">Limpiar</button>
      </div>
      <div class="text-xs text-gray-600 mt-2" id="existenciaStatus">0 registros.</div>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 mt-4">
      <h3 class="font-semibold mb-2">Vista previa existencia agrupada</h3>
      <div id="existenciaPreview" class="overflow-auto max-h-64 border rounded-xl"></div>
    </div>
  </section>

  <!-- Escanear -->
  <section id="tab-escanear" class="tab-pane hidden">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">Escaneo con cámara / Registro manual</h2>

      <!-- Metadatos -->
      <div class="grid md:grid-cols-3 gap-2 mb-3">
        <input id="metaNombre" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Nombre del conteo (p.ej. CÍCLICO OFERTA DAMA)" />
        <input id="metaOperador" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Operador (p.ej. Fulanito XXXX)" />
        <input id="metaNotas" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Notas (opcional)" />
      </div>

      <div class="flex flex-wrap gap-2 mb-4">
        <button id="btnGuardarHistorico" class="btn bg-emerald-600 text-white">Guardar en histórico</button>
        <button id="btnNuevaSesion" class="btn bg-orange-500 text-white">Nueva sesión</button>
        <button id="btnAudio" class="btn bg-purple-600 text-white">Activar sonidos</button>
        <span id="lastStatus" class="badge bg-gray-100 text-gray-700">—</span>
      </div>

      <p class="text-xs text-gray-600 mb-3">HTTPS/localhost. Si no detecta, cambia a Quagga2. Usa Registro manual si no hay código o hay cantidad.</p>

      <div class="grid md:grid-cols-2 gap-4 mb-3">
        <!-- Manual -->
        <div>
          <label class="text-xs text-gray-500">Entrada con lector/teclado</label>
          <input id="scanInput" type="text" class="w-full rounded-xl border border-gray-200 p-3 mb-2" placeholder="Escanea o escribe: 10902400 ó 000-01,ORO-240 ó 000-01|ORO|240" />
          <div class="flex flex-wrap gap-2 mb-4">
            <button id="btnUndo" class="btn bg-gray-100">Deshacer</button>
            <button id="btnResetEscaneo" class="btn bg-gray-100">Reiniciar</button>
            <button id="btnCargarPruebaEscaneo" class="btn bg-gray-100">Prueba</button>
          </div>

          <div class="border-t pt-3 mt-2">
            <h3 class="font-semibold text-sm mb-2">Registrar manual</h3>
            <div class="grid grid-cols-5 gap-2 items-center">
              <input id="manualClave" class="col-span-3 rounded-lg border border-gray-200 p-2 text-sm" placeholder="Clave o código (MOD|COLOR|TALLA / 10902400)" />
              <input id="manualQty" type="number" min="1" value="1" class="col-span-1 rounded-lg border border-gray-200 p-2 text-sm" />
              <button id="btnManual" class="col-span-1 btn bg-blue-600 text-white">Registrar</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Acepta <b>MOD|COLOR|TALLA</b>, <b>MOD,COLOR-TALLA</b> o <b>código de barras</b>. Cantidad > 1 duplica el registro.</p>
          </div>
        </div>

        <!-- Cámara -->
        <div>
          <label class="text-xs text-gray-500">Cámara</label>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <select id="cameraSelect" class="border rounded p-1 text-xs"></select>
            <select id="engineSelect" class="border rounded p-1 text-xs">
              <option value="bd">Barcode Detector (rápido)</option>
              <option value="quagga">Quagga2 (compatibilidad)</option>
            </select>
            <button id="btnSolicitarPermisos" class="btn bg-indigo-600 text-white">Permisos</button>
            <button id="btnCamStart" class="btn bg-green-600 text-white">Iniciar</button>
            <button id="btnCamStop" class="btn bg-gray-100">Detener</button>
            <button id="btnTogglePause" class="btn bg-yellow-500 text-white">Pausar escaneo</button>
            <label class="flex items-center gap-2 text-xs ml-2"><input id="chkAuto" type="checkbox" checked> Auto-agregar</label>
            <label class="flex items-center gap-2 text-xs ml-2"><input id="chkBeep" type="checkbox" checked> Beep</label>
            <button id="btnTorch" class="btn bg-gray-100">Linterna</button>
            <button id="btnFullscreen" class="btn bg-gray-100">Pantalla completa</button>
          </div>
          <div class="text-xs" id="httpsStatus"></div>

          <div id="quaggaArea" class="cam-compact rounded-xl border border-gray-200 overflow-hidden bg-black mt-2">
            <video id="videoCam" class="w-full h-full" autoplay playsinline muted></video>
            <canvas id="quaggaOverlay"></canvas>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <h3 class="font-semibold mb-2">Últimos escaneos (local)</h3>
          <div id="scanLog" class="overflow-auto max-h-64 border rounded-xl"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Acumulado por clave (local)</h3>
          <div id="scanGrouped" class="overflow-auto max-h-64 border rounded-xl"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Feed en vivo (Firestore)</h3>
          <div id="liveFeed" class="overflow-auto max-h-64 border rounded-xl">
            <table class="min-w-full text-xs table">
              <thead>
                <tr>
                  <th class="text-left">Hora</th>
                  <th class="text-left">Clave</th>
                  <th class="text-left">Operador</th>
                  <th class="text-left">Dispositivo</th>
                </tr>
              </thead>
              <tbody id="liveFeedBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="mt-3 text-xs text-gray-500 mono" id="diag"></div>
    </div>
  </section>

  <!-- Reporte -->
  <section id="tab-reporte" class="tab-pane hidden">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">Reporte (Escaneados vs Existencia)</h2>
      <div class="flex flex-wrap gap-2 mb-3 no-print">
        <button id="btnGenerarReporte" class="btn bg-blue-600 text-white">Generar</button>
        <button id="btnExportarCSV" class="btn bg-gray-100">Exportar CSV</button>
        <button id="btnRespaldarJSON" class="btn bg-gray-100">Respaldo JSON</button>
        <button id="btnImprimir" class="btn bg-gray-100" onclick="window.print()">Imprimir</button>
      </div>
      <div class="bg-gray-50 border rounded-xl p-3 mb-3 no-print">
        <h3 class="font-semibold mb-2">Filtros</h3>
        <div class="grid md:grid-cols-4 gap-2">
          <input id="filtroMOD" placeholder="Filtrar MOD" class="rounded-lg border border-gray-200 p-2 text-sm"/>
          <input id="filtroCOLOR" placeholder="Filtrar COLOR" class="rounded-lg border border-gray-200 p-2 text-sm"/>
          <input id="filtroTALLA" placeholder="Filtrar TALLA" class="rounded-lg border border-gray-200 p-2 text-sm"/>
          <input id="filtroTEMP" placeholder="Filtrar TEMPORADA" class="rounded-lg border border-gray-200 p-2 text-sm"/>
        </div>
      </div>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Escaneados</h3>
          <div id="tablaEscaneados" class="overflow-auto max-h-80"></div>
        </div>
        <div class="border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Sobrantes</h3>
          <div id="tablaSobrantes" class="overflow-auto max-h-80"></div>
        </div>
        <div class="border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Faltantes</h3>
          <div id="tablaFaltantes" class="overflow-auto max-h-80"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Historial local -->
  <section id="tab-historial" class="tab-pane hidden">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">Historial de conteos (local)</h2>
      <div id="histList" class="overflow-auto max-h-[70vh] border rounded-xl"></div>
      <div class="text-xs text-gray-500 mt-2">Se guarda en <code>localStorage</code>. Para multi-dispositivo, usa el mismo “Nombre del conteo” con Firebase configurado.</div>
    </div>
  </section>

  <footer class="mt-6 text-xs text-gray-500 no-print">
    Local keys: <code>conteo_cklass_v01</code>, <code>conteo_cklass_hist</code>.
  </footer>
</div>

<!-- Quagga2 -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<!-- ============== Código principal (incluye Firebase v12) ============== -->
<script type="module">
/* ---------------- Tabs robustas ---------------- */
(() => {
  try {
    const tabs = document.querySelectorAll('.tab-btn');
    const panes = {
      importar: document.getElementById('tab-importar'),
      escanear: document.getElementById('tab-escanear'),
      reporte: document.getElementById('tab-reporte'),
      historial: document.getElementById('tab-historial'),
    };
    function activate(tab) {
      tabs.forEach(b => {
        b.classList.toggle('text-blue-600', b.dataset.tab===tab);
        b.classList.toggle('border-blue-600', b.dataset.tab===tab);
      });
      Object.entries(panes).forEach(([k, el]) => {
        el.classList.toggle('hidden', k !== tab);
        el.classList.toggle('block', k === tab);
      });
      location.hash = '#'+tab;
    }
    tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));
    window.addEventListener('hashchange', () => activate((location.hash||'#importar').slice(1)));
    activate((location.hash||'#importar').slice(1));
  } catch (e) { console.error('Tabs error', e); }
})();

/* ---------------- Firebase (CDN v12.1.0) ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* >>>>>>>>>>>> CONFIG REAL (tomada de tu mensaje) <<<<<<<<<<<<< */
const firebaseConfig = {
  apiKey: "AIzaSyBGUDLrMfj-8GAJMemkfcHAGmGucMyKKzA",
  authDomain: "cklass-conteo.firebaseapp.com",
  projectId: "cklass-conteo",
  storageBucket: "cklass-conteo.firebasestorage.app",
  messagingSenderId: "695313165938",
  appId: "1:695313165938:web:26f2b2f7276968a1ccdceb",
  measurementId: "G-45LC81EE44"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
console.log("Firebase listo");

/* ---------------- Estado/refs ---------------- */
const QUIRKS = { cameraActive:false, track:null, torchOn:false };
const state = { catalog:new Map(), indexByKey:new Map(), keyMeta:new Map(), existencia:new Map(), scans:[], groupedScans:new Map() };
let SCAN_PAUSED = false;             /* ⚠️ SOLO UNA VEZ */
const deviceId = (localStorage.getItem('conteo_device_id') || (crypto.randomUUID?.() || String(Math.random()).slice(2)));
localStorage.setItem('conteo_device_id', deviceId);
const processedNonces = new Set();

const els = {
  fileCatalogo: document.getElementById('fileCatalogo'), catalogoStatus:document.getElementById('catalogoStatus'),
  fileExistenciaCSV: document.getElementById('fileExistenciaCSV'), existenciaCSVStatus:document.getElementById('existenciaCSVStatus'),
  existenciaInput: document.getElementById('existenciaInput'), btnProcesarExistencia:document.getElementById('btnProcesarExistencia'), btnLimpiarExistencia:document.getElementById('btnLimpiarExistencia'),
  existenciaStatus: document.getElementById('existenciaStatus'), existenciaPreview: document.getElementById('existenciaPreview'),
  scanInput: document.getElementById('scanInput'), scanLog: document.getElementById('scanLog'), scanGrouped: document.getElementById('scanGrouped'),
  btnUndo: document.getElementById('btnUndo'), btnResetEscaneo: document.getElementById('btnResetEscaneo'), btnCargarPruebaEscaneo: document.getElementById('btnCargarPruebaEscaneo'),
  cameraSelect: document.getElementById('cameraSelect'), engineSelect: document.getElementById('engineSelect'),
  btnSolicitarPermisos:document.getElementById('btnSolicitarPermisos'),
  btnCamStart: document.getElementById('btnCamStart'), btnCamStop:document.getElementById('btnCamStop'), btnFullscreen:document.getElementById('btnFullscreen'),
  btnTorch: document.getElementById('btnTorch'), btnTogglePause: document.getElementById('btnTogglePause'),
  httpsStatus:document.getElementById('httpsStatus'), videoCam:document.getElementById('videoCam'), diag: document.getElementById('diag'),
  btnGenerarReporte: document.getElementById('btnGenerarReporte'), btnExportarCSV:document.getElementById('btnExportarCSV'), btnRespaldarJSON:document.getElementById('btnRespaldarJSON'),
  tablaEscaneados: document.getElementById('tablaEscaneados'), tablaSobrantes:document.getElementById('tablaSobrantes'), tablaFaltantes:document.getElementById('tablaFaltantes'),
  filtroMOD: document.getElementById('filtroMOD'), filtroCOLOR: document.getElementById('filtroCOLOR'), filtroTALLA: document.getElementById('filtroTALLA'), filtroTEMP: document.getElementById('filtroTEMP'),
  chkAuto: document.getElementById('chkAuto'), chkBeep: document.getElementById('chkBeep'),
  quaggaOverlay: document.getElementById('quaggaOverlay'), quaggaArea: document.getElementById('quaggaArea'),
  manualClave: document.getElementById('manualClave'), manualQty: document.getElementById('manualQty'), btnManual: document.getElementById('btnManual'),
  lastStatus: document.getElementById('lastStatus'), btnAudio: document.getElementById('btnAudio'),
  metaNombre: document.getElementById('metaNombre'), metaOperador: document.getElementById('metaOperador'), metaNotas: document.getElementById('metaNotas'),
  btnGuardarHistorico: document.getElementById('btnGuardarHistorico'), btnNuevaSesion: document.getElementById('btnNuevaSesion'),
  histList: document.getElementById('histList'),
  liveFeedBody: document.getElementById('liveFeedBody')
};

/* ---------------- HTTPS check ---------------- */
function updateHttpsStatus(){
  const isSecure = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
  els.httpsStatus.innerHTML = isSecure
    ? '<span class="text-green-700">Contexto seguro ✔ (HTTPS/localhost).</span>'
    : `<span class="text-red-700">Contexto NO seguro ✖ (${location.protocol}).</span>`;
}
updateHttpsStatus();

/* ---------------- Sonidos WebAudio ---------------- */
let audioCtx = null, audioReady = false;
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); audioReady = true; playTone(900, 60, 'square', 0.06); }
function playTone(freq=880, ms=90, type='sine', gain=0.08) { if (!audioReady || !audioCtx) return; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = type; osc.frequency.value = freq; g.gain.value = gain; osc.connect(g).connect(audioCtx.destination); const now = audioCtx.currentTime; osc.start(now); osc.stop(now + ms/1000); }
function playOk(){ if(!els.chkBeep.checked) return; playTone(1200, 90, 'square', 0.08); }
function playErr(){ playTone(220, 140, 'sawtooth', 0.10); }
function buzz(pattern=[120]){ if (navigator.vibrate) navigator.vibrate(pattern); }
els.btnAudio.addEventListener('click', initAudio);
const _unlock = ()=>{ initAudio(); document.removeEventListener('click', _unlock); document.removeEventListener('keydown', _unlock); };
document.addEventListener('click', _unlock, { once:true });
document.addEventListener('keydown', _unlock, { once:true });

/* ---------------- Utilidades ---------------- */
const toKey = (mod, color, talla) => `${(mod||'').trim()}|${(color||'').trim()}|${(talla||'').trim()}`.toUpperCase();
function parseLine(line){ line=line.trim(); if(!line) return null;
  if(/^\d{6,}$/.test(line)){ const item=state.catalog.get(line); if(!item) return {type:'BC_NO_ENCONTRADO', raw:line}; return {type:'KEY', key:toKey(item.MOD,item.COLOR,item.TALLA)}; }
  if(line.includes('|')){ const [m,c,t]=line.split('|').map(s=>s.trim()); if(!m||!c||!t) return null; return {type:'KEY', key:toKey(m,c,t)}; }
  if(line.includes(',')){ const [mod,tail]=line.split(','); if(!mod||!tail) return null; if(tail.includes('-')){const [color,talla]=tail.split('-'); return {type:'KEY', key:toKey(mod,color,talla)};}
  }
  return null;
}
function renderTable(map, headers=['Clave','Cantidad']){
  const rows=[...map.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  return ['<table class="min-w-full text-sm">', `<thead><tr>${headers.map(h=>`<th class="text-left px-2 py-1 border-b">${h}</th>`).join('')}</tr></thead>`, '<tbody>',
    ...rows.map(([k,v])=>`<tr><td class="px-2 py-1 border-b">${k}</td><td class="px-2 py-1 border-b">${v}</td></tr>`), '</tbody></table>'].join('');
}
function renderLog(list){ const last=list.slice(-50).reverse(); return ['<table class="min-w-full text-xs table"><thead><tr><th>#</th><th>Entrada</th></tr></thead><tbody>', ...last.map((x,i)=>`<tr><td>${last.length-i}</td><td>${x}</td></tr>`), '</tbody></table>'].join(''); }
function group(list){ const m=new Map(); for(const k of list) if(!k.startsWith||!k.startsWith('[NO ENCONTRADO]')) m.set(k,(m.get(k)||0)+1); return m; }
function exportCSV(sections){ let csv='SECCION,CLAVE,CANTIDAD\n'; for(const [name,map] of sections) for(const [k,v] of map.entries()) csv+=`${name},"${k.replaceAll('"','""')}",${v}\n`; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='reporte_conteo.csv'; a.click(); URL.revokeObjectURL(url); }
function saveLocal(){ const d={catalog:[...state.catalog], indexByKey:[...state.indexByKey], keyMeta:[...state.keyMeta], existencia:[...state.existencia], scans:state.scans, v:'hist-fb-v1'}; localStorage.setItem('conteo_cklass_v01', JSON.stringify(d)); }
function loadLocal(){ const raw=localStorage.getItem('conteo_cklass_v01'); if(!raw) return; try{ const d=JSON.parse(raw); state.catalog=new Map(d.catalog||[]); state.indexByKey=new Map(d.indexByKey||[]); state.keyMeta=new Map(d.keyMeta||[]); state.existencia=new Map(d.existencia||[]); state.scans=d.scans||[]; state.groupedScans=group(state.scans);}catch(e){} }
function refreshUI(){ els.catalogoStatus.textContent=`${state.catalog.size} códigos de barras cargados.`; els.existenciaStatus.textContent=`${state.existencia.size} claves agrupadas.`; els.existenciaPreview.innerHTML=renderTable(state.existencia); els.scanLog.innerHTML=renderLog(state.scans); els.scanGrouped.innerHTML=renderTable(state.groupedScans); }
function setStatusOk(msg='OK'){ els.lastStatus.textContent=msg; els.lastStatus.className='badge bg-green-100 text-green-700'; }
function setStatusErr(msg='ERROR'){ els.lastStatus.textContent=msg; els.lastStatus.className='badge bg-red-100 text-red-700'; }

/* ---------------- Importar ---------------- */
fileCatalogo.addEventListener('change', async (e)=>{
  const text=await e.target.files?.[0]?.text(); if(!text) return;
  const lines=text.split(/\r?\n/); const header=lines.shift(); const cols=header.split(',').map(x=>x.trim().toUpperCase());
  const idx={BC:cols.indexOf('CODIGO_BARRA'), MOD:cols.indexOf('MOD'), COLOR:cols.indexOf('COLOR'), TALLA:cols.indexOf('TALLA'), TEMP:cols.indexOf('TEMPORADA')};
  for(const line of lines){ if(!line.trim()) continue; const p=line.split(','); const bc=(p[idx.BC]||'').trim(); if(!bc) continue;
    const MOD=(p[idx.MOD]||'').trim(), COLOR=(p[idx.COLOR]||'').trim(), TALLA=(p[idx.TALLA]||'').trim(), TEMP=(p[idx.TEMP]||'').trim();
    const key=toKey(MOD,COLOR,TALLA);
    state.catalog.set(bc,{MOD,COLOR,TALLA,TEMPORADA:TEMP});
    if(!state.indexByKey.has(key)) state.indexByKey.set(key,[]);
    state.indexByKey.get(key).push(bc);
    if(!state.keyMeta.has(key)) state.keyMeta.set(key,{MOD,COLOR,TALLA,TEMPORADA:TEMP});
  }
  els.catalogoStatus.textContent=`${state.catalog.size} códigos de barras cargados.`; saveLocal(); refreshUI();
});
fileExistenciaCSV.addEventListener('change', async (e)=>{ const text=await e.target.files?.[0]?.text(); if(!text) return; parseExistenciaCSV(text); saveLocal(); refreshUI(); });
function parseExistenciaCSV(text){
  const lines=text.split(/\r?\n/).filter(Boolean); if(!lines.length) return;
  const cols=lines.shift().split(',').map(x=>x.trim().toUpperCase());
  const idx={KEY:cols.indexOf('CODIGO-COLOR-TALLA'), MOD:cols.indexOf('MOD'), COLOR:cols.indexOf('COLOR'), TALLA:cols.indexOf('TALLA'), CANT:cols.indexOf('CANTIDAD')};
  const acc=new Map();
  for(const line of lines){
    const p=line.split(',');
    let key=''; let qty=1; if(idx.CANT>=0) qty=parseInt((p[idx.CANT]||'1').trim(),10)||0;
    if(idx.MOD>=0 && idx.COLOR>=0 && idx.TALLA>=0){ key=toKey(p[idx.MOD]||'',p[idx.COLOR]||'',p[idx.TALLA||'']); }
    else if(idx.KEY>=0 && p[idx.KEY]){
      const raw=p[idx.KEY].trim();
      if(raw.includes(',')){ const [mod,tail]=raw.split(','); const [color,talla]=(tail||'').split('-'); key=toKey(mod||'',color||'',talla||''); }
      else if(raw.includes('-')){ const [mod,color,talla]=raw.split('-'); key=toKey(mod||'',color||'',talla||''); }
    }
    if(!key) continue;
    acc.set(key,(acc.get(key)||0)+(qty||0));
    if(!state.keyMeta.has(key)){ const [MOD,COLOR,TALLA]=key.split('|'); state.keyMeta.set(key,{MOD,COLOR,TALLA,TEMPORADA:''}); }
  }
  state.existencia=acc; els.existenciaCSVStatus.textContent=`${state.existencia.size} claves cargadas.`;
}

/* ---------------- Pegar existencia ---------------- */
btnProcesarExistencia.addEventListener('click',()=>{
  const keys=[]; const notFound=[];
  existenciaInput.value.split(/\r?\n/).forEach(line=>{ const p=parseLine(line); if(!p) return; if(p.type==='BC_NO_ENCONTRADO') notFound.push(p.raw); else if(p.type==='KEY') keys.push(p.key); });
  state.existencia=group(keys); existenciaStatus.textContent=`${state.existencia.size} claves agrupadas. ${notFound.length?('No encontrados: '+notFound.length):''}`; existenciaPreview.innerHTML=renderTable(state.existencia); saveLocal();
});
btnLimpiarExistencia.addEventListener('click',()=>{ existenciaInput.value=''; state.existencia.clear(); existenciaPreview.innerHTML=''; existenciaStatus.textContent='0 registros.'; saveLocal(); });

/* ---------------- Escaneo/Manual ---------------- */
scanInput.addEventListener('keydown',(e)=>{ if(e.key!=='Enter') return; const line=e.target.value.trim(); e.target.value=''; if(!line) return; addScanLine(line); });
function addScanLine(line){
  const p=parseLine(line);
  if(!p){ setStatusErr('Entrada inválida'); playErr(); buzz([70]); alert('Entrada inválida. Usa MOD|COLOR|TALLA o código de barras.'); return; }
  if(p.type==='BC_NO_ENCONTRADO'){ setStatusErr('BC no existe'); playErr(); buzz([70]); alert('Código no encontrado en catálogo: '+p.raw); return; }
  if(p.type==='KEY'){ registerKey(p.key); }
}
btnManual.addEventListener('click', ()=>{
  const clave = (manualClave.value||'').trim();
  let qty = parseInt((manualQty.value||'1'),10); if(!qty || qty<1) qty=1;
  if(!clave){ setStatusErr('Entrada vacía'); playErr(); buzz([70]); return; }
  if(/^\d{6,}$/.test(clave)){
    const item = state.catalog.get(clave);
    if(!item){ setStatusErr('BC no existe'); playErr(); buzz([70]); alert('Código no encontrado en catálogo: '+clave); return; }
    const key = toKey(item.MOD,item.COLOR,item.TALLA);
    for(let i=0;i<qty;i++) registerKey(key);
  }else{
    let parsed = parseLine(clave);
    if(!parsed){ setStatusErr('Clave inválida'); playErr(); buzz([70]); alert('Entrada inválida. Usa MOD|COLOR|TALLA o código de barras.'); return; }
    if(parsed.type==='BC_NO_ENCONTRADO'){ setStatusErr('BC no existe'); playErr(); buzz([70]); alert('Código no encontrado en catálogo: '+clave); return; }
    if(parsed.type==='KEY'){ for(let i=0;i<qty;i++) registerKey(parsed.key); }
  }
  manualClave.value=''; manualQty.value='1';
});

/* ---------------- Antirrebote cámara ---------------- */
const FRAME_COOLDOWN_MS = 220;
const SAME_CODE_COOLDOWN_MS = 1800;
let lastFrameAt = 0;
const seenRecently = new Map();
function canAccept(code){
  const now = Date.now();
  if (now - lastFrameAt < FRAME_COOLDOWN_MS) return false;
  lastFrameAt = now;
  const last = seenRecently.get(code) || 0;
  if (now - last < SAME_CODE_COOLDOWN_MS) return false;
  seenRecently.set(code, now);
  for (const [c,t] of seenRecently) if (now - t > SAME_CODE_COOLDOWN_MS*3) seenRecently.delete(c);
  return true;
}

/* ---------------- Cámara: BarcodeDetector / Quagga2 ---------------- */
const supportsBarcode = "BarcodeDetector" in window;
let detector = supportsBarcode ? new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','itf','codabar']}) : null;
let camStream=null, detectLoop=null, quaggaActive=false;

function log(msg){ diag.textContent = (msg+"\n") + diag.textContent; }
async function listCameras(){
  try{
    const devices=await navigator.mediaDevices.enumerateDevices();
    const vids=devices.filter(d=>d.kind==='videoinput');
    cameraSelect.innerHTML = vids.map((d,i)=>`<option value="${d.deviceId}">${d.label || 'Cámara '+(i+1)}</option>`).join('');
    log('Videoinputs: '+vids.length);
  }catch(e){ cameraSelect.innerHTML='<option value="">Cámara predeterminada</option>'; log('enumerateDevices error: '+e.message); }
}
navigator.mediaDevices?.enumerateDevices && listCameras();

btnSolicitarPermisos.addEventListener('click', async ()=>{
  updateHttpsStatus();
  try{
    const tmp = await navigator.mediaDevices.getUserMedia({ video: { facingMode: {ideal:'environment'} }, audio:false });
    tmp.getTracks().forEach(t=>t.stop());
    alert('Permiso de cámara concedido. Ahora puedes iniciar.');
    await listCameras();
  }catch(e){
    log('getUserMedia error: '+(e && (e.name+': '+e.message)));
    alert('No fue posible solicitar permisos. Revisa HTTPS/localhost.');
  }
});

btnTogglePause.addEventListener('click', ()=>{
  SCAN_PAUSED = !SCAN_PAUSED;
  btnTogglePause.textContent = SCAN_PAUSED ? 'Reanudar escaneo' : 'Pausar escaneo';
  btnTogglePause.className = SCAN_PAUSED ? 'btn bg-blue-500 text-white' : 'btn bg-yellow-500 text-white';
  setStatusOk(SCAN_PAUSED ? 'PAUSADO' : 'EN ESCANEO');
});

btnCamStart.addEventListener('click', ()=>{ const engine = engineSelect.value; if (engine === 'bd') startBD(); else startQuagga(); });
btnCamStop.addEventListener('click', stopAll);
btnFullscreen.addEventListener('click', ()=>{ const el=document.documentElement; if(document.fullscreenElement) document.exitFullscreen(); else el.requestFullscreen?.(); });

btnTorch.addEventListener('click', async ()=>{
  try{
    if (!QUIRKS.track) return alert('Cámara no activa');
    const caps = QUIRKS.track.getCapabilities?.(); if(!caps || !caps.torch) return alert('Tu dispositivo no soporta linterna');
    QUIRKS.torchOn = !QUIRKS.torchOn;
    await QUIRKS.track.applyConstraints({advanced:[{torch: QUIRKS.torchOn}]});
  }catch(e){ alert('No fue posible activar la linterna'); }
});

// --- BarcodeDetector ---
async function startBD(){
  stopQuagga();
  if (!supportsBarcode) { alert('Barcode Detector no soportado. Usa Quagga2.'); return; }
  try{
    const devId = cameraSelect.value || undefined;
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: devId ? {exact: devId} : undefined, facingMode: devId? undefined : {ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    videoCam.srcObject = camStream;
    QUIRKS.track = camStream.getVideoTracks()[0] || null;
    runDetectLoop();
  }catch(e){ log('startBD error: '+(e && (e.name+': '+e.message))); alert('No se pudo iniciar BD. Prueba motor Quagga2.'); }
}
function stopBD(){ try{ camStream?.getTracks()?.forEach(t=>t.stop()); }catch(_){}
  camStream=null; QUIRKS.track=null; if(detectLoop) cancelAnimationFrame(detectLoop); detectLoop=null; }
function runDetectLoop(){
  const step = async () => {
    if(!camStream) return;
    try{
      if (SCAN_PAUSED) { detectLoop = requestAnimationFrame(step); return; }
      const ts=performance.now();
      if(!runDetectLoop._last || ts-runDetectLoop._last > 160){
        runDetectLoop._last = ts;
        const codes = await detector.detect(videoCam);
        if (codes && codes.length) {
          const raw = codes[0].rawValue?.trim();
          if (raw && canAccept(raw)) handleScannedRaw(raw);
        }
      }
    }catch(e){}
    detectLoop = requestAnimationFrame(step);
  };
  detectLoop = requestAnimationFrame(step);
}

// --- Quagga2 ---
function startQuagga(){
  stopBD();
  const readers = [
    "ean_reader","ean_8_reader","upc_reader","upc_e_reader",
    "code_128_reader","code_39_reader","code_39_vin_reader",
    "codabar_reader","i2of5_reader","2of5_reader"
  ];
  const config = {
    inputStream: { type: "LiveStream", target: quaggaArea, constraints: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } },
    locator: { patchSize: "medium", halfSample: true },
    decoder: { readers }, locate: true,
    numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, navigator.hardwareConcurrency - 1) : 2
  };
  window.Quagga?.init(config, err => {
    if (err) { log("Quagga init error: "+err); alert("No se pudo iniciar Quagga."); return; }
    window.Quagga.start(); quaggaActive = true; overlayResize();
  });
  window.Quagga?.onDetected(onQuaggaDetected);
  window.Quagga?.onProcessed(drawQuaggaBoxes);
}
function stopQuagga(){ try { window.Quagga?.stop(); } catch(_) {} quaggaActive = false; clearOverlay(); }
function onQuaggaDetected(data){
  if (SCAN_PAUSED) return;
  const raw = data?.codeResult?.code?.trim();
  if (!raw) return;
  if (!canAccept(raw)) return;
  handleScannedRaw(raw);
}
function drawQuaggaBoxes(result){
  const ctx = quaggaOverlay.getContext("2d");
  clearOverlay(); if (!result) return;
  const draw = (path, color, width=2) => { ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y); for (let i=1;i<path.length;i++) ctx.lineTo(path[i].x, path[i].y); ctx.lineTo(path[0].x, path[0].y); ctx.lineWidth = width; ctx.strokeStyle = color; ctx.stroke(); };
  if (result.boxes) result.boxes.filter(b=>b !== result.box).forEach(b => draw(b, "rgba(255,255,255,0.4)", 1));
  if (result.box) draw(result.box, "rgba(0,255,0,0.8)", 3);
}
function overlayResize(){ const rect = quaggaArea.getBoundingClientRect(); quaggaOverlay.width = rect.width; quaggaOverlay.height = rect.height; }
function clearOverlay(){ const ctx = quaggaOverlay.getContext("2d"); ctx.clearRect(0,0,quaggaOverlay.width, quaggaOverlay.height); }
window.addEventListener("resize", overlayResize);

// --- Stop all ---
function stopAll(){ stopBD(); stopQuagga(); }

/* ---------------- Registro (local + Firestore) ---------------- */
function handleScannedRaw(raw){
  const item = state.catalog.get(raw);
  if(item){
    const key = toKey(item.MOD,item.COLOR,item.TALLA);
    if (chkAuto.checked) registerKey(key);
    setStatusOk('OK: ' + raw); playOk();
  }else{
    setStatusErr('NO EN CATÁLOGO: ' + raw);
    playErr(); buzz([80,40,80]);
    alert('Código NO encontrado en catálogo: ' + raw + '\n\nNo se registró. Verifica el catálogo o usa "Registrar manual".');
  }
}
function currentSession(){ return (metaNombre.value?.trim() || 'SESION_SIN_NOMBRE').toUpperCase(); }

async function registerKey(key){
  // Cloud primero (si falla, local)
  try{
    const ref = collection(db, 'conteos', currentSession(), 'eventos');
    const nonce = crypto.randomUUID?.() || (Date.now() + '_' + Math.random().toString(36).slice(2));
    processedNonces.add(nonce);
    await addDoc(ref, { t: serverTimestamp(), deviceId, key, nonce, operador: (metaOperador.value||'').trim() });
    diag.textContent = `Enviado → ${key}\n` + diag.textContent;
  }catch(e){
    state.scans.push(key);
    state.groupedScans = group(state.scans);
    refreshUI(); saveLocal();
    diag.textContent = `Local fallback → ${key} (${e?.message||e})\n` + diag.textContent;
  }
}

// Listener Firestore por sesión (eventos + feed en vivo)
let unsubscribe = null;
function listenSession(){
  if (unsubscribe) { unsubscribe(); unsubscribe=null; }
  const ref = collection(db, 'conteos', currentSession(), 'eventos');
  const q = query(ref, orderBy('t', 'asc'), limit(1000));
  unsubscribe = onSnapshot(q, snap=>{
    let changed = false;
    const feedRows = [];
    snap.forEach(doc=>{
      const d = doc.data();
      const key = d.key;
      const op = d.operador || '';
      const dev = (d.deviceId || '').slice(0,6);
      const when = d.t?.toDate?.() ? d.t.toDate() : null;
      const hh = when ? when.toLocaleTimeString() : '—';
      feedRows.push(`<tr><td>${hh}</td><td>${key||''}</td><td>${op}</td><td>${dev}</td></tr>`);
    });
    liveFeedBody.innerHTML = feedRows.reverse().slice(0,100).join('');

    snap.docChanges().forEach(ch=>{
      if (ch.type === 'added') {
        const data = ch.doc.data();
        const { key, nonce } = data || {};
        if (!key) return;
        if (nonce && processedNonces.has(nonce)) { processedNonces.delete(nonce); return; } // evita doble
        state.scans.push(key);
        changed = true;
      }
    });
    if (changed) { state.groupedScans = group(state.scans); refreshUI(); saveLocal(); }
  });
}
metaNombre.addEventListener('change', listenSession);

/* ---------------- Reporte ---------------- */
const filtros = { MOD: document.getElementById('filtroMOD'), COLOR: document.getElementById('filtroCOLOR'), TALLA: document.getElementById('filtroTALLA'), TEMP: document.getElementById('filtroTEMP') };
function keyPassesFilters(key){ const [MOD,COLOR,TALLA]=key.split('|'); const TEMP=(state.keyMeta.get(key)?.TEMPORADA||'').toUpperCase();
  if(filtros.MOD.value && !MOD.toUpperCase().includes(filtros.MOD.value.toUpperCase())) return false;
  if(filtros.COLOR.value && !COLOR.toUpperCase().includes(filtros.COLOR.value.toUpperCase())) return false;
  if(filtros.TALLA.value && !TALLA.toUpperCase().includes(filtros.TALLA.value.toUpperCase())) return false;
  if(filtros.TEMP.value && !TEMP.includes(filtros.TEMP.value.toUpperCase())) return false;
  return true;
}
Object.values(filtros).forEach(inp=>inp.addEventListener('input',()=>generateReport(true)));
function generateReport(skipScroll){
  const esc=state.groupedScans, exi=state.existencia, sobr=new Map(), falt=new Map(), escT=new Map();
  const keys=new Set([...esc.keys(),...exi.keys()]);
  for(const k of keys){
    if(!keyPassesFilters(k)) continue;
    const e=esc.get(k)||0, x=exi.get(k)||0;
    if(e>0) escT.set(k,e); if(e-x>0) sobr.set(k,e-x); if(x-e>0) falt.set(k,x-e);
  }
  tablaEscaneados.innerHTML=renderTable(escT,['Clave','Escaneado']);
  tablaSobrantes.innerHTML=renderTable(sobr,['Clave','Sobrante']);
  tablaFaltantes.innerHTML=renderTable(falt,['Clave','Faltante']);
  if(!skipScroll) document.getElementById('tab-reporte').scrollIntoView({behavior:'smooth'});
  return {escT,sobr,falt};
}
btnGenerarReporte.addEventListener('click',()=>generateReport());
btnExportarCSV.addEventListener('click',()=>{ const {escT,sobr,falt}=generateReport(true); exportCSV([['ESCANEADOS',escT],['SOBRANTES',sobr],['FALTANTES',falt]]); });
btnRespaldarJSON.addEventListener('click',()=>{ const d={catalog:[...state.catalog], indexByKey:[...state.indexByKey], keyMeta:[...state.keyMeta], existencia:[...state.existencia], scans:state.scans, v:'hist-fb-v1'}; const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='respaldo_conteo_cklass.json'; a.click(); URL.revokeObjectURL(url); });

/* ---------------- Historial local ---------------- */
function loadHist(){ try{ return JSON.parse(localStorage.getItem('conteo_cklass_hist')||'[]'); }catch(_){ return []; } }
function saveHist(list){ localStorage.setItem('conteo_cklass_hist', JSON.stringify(list)); }
function makeSnapshot(){
  const nombre = metaNombre.value?.trim() || '(sin nombre)';
  const operador = metaOperador.value?.trim() || '(sin operador)';
  const notas = metaNotas.value?.trim() || '';
  const when = new Date();
  return {
    id: crypto.randomUUID?.() || String(when.getTime())+'_'+Math.random().toString(36).slice(2),
    nombre, operador, notas,
    fechaIso: when.toISOString(), fechaLocal: when.toLocaleString(), deviceId,
    existencia: [...state.existencia], scans: state.scans.slice(), groupedScans: [...state.groupedScans],
    totals: { escaneados: state.scans.length, claves: state.groupedScans.size, existenciaClaves: state.existencia.size }
  };
}
function renderHist(){
  const list = loadHist();
  if(!list.length){ histList.innerHTML = '<div class="p-3 text-sm text-gray-600">No hay conteos guardados.</div>'; return; }
  const rows = list.slice().reverse().map(h=>`
    <tr>
      <td class="px-2 py-2 border-b">${h.fechaLocal}</td>
      <td class="px-2 py-2 border-b font-medium">${h.nombre}</td>
      <td class="px-2 py-2 border-b">${h.operador}</td>
      <td class="px-2 py-2 border-b text-xs">${h.notas||''}</td>
      <td class="px-2 py-2 border-b text-right">${h.totals?.escaneados||0}</td>
      <td class="px-2 py-2 border-b text-right">${h.totals?.claves||0}</td>
      <td class="px-2 py-2 border-b">
        <div class="flex flex-wrap gap-2">
          <button class="btn bg-blue-600 text-white" onclick="reabrirHist('${h.id}')">Reabrir</button>
          <button class="btn bg-gray-100" onclick="exportHistCSV('${h.id}')">CSV</button>
          <button class="btn bg-gray-100" onclick="exportHistJSON('${h.id}')">JSON</button>
          <button class="btn bg-red-600 text-white" onclick="borrarHist('${h.id}')">Eliminar</button>
        </div>
      </td>
    </tr>`).join('');
  histList.innerHTML = `<table class="min-w-full text-sm table">
    <thead><tr>
      <th class="text-left">Fecha</th>
      <th class="text-left">Nombre</th>
      <th class="text-left">Operador</th>
      <th class="text-left">Notas</th>
      <th class="text-right">Escaneos</th>
      <th class="text-right">Claves</th>
      <th class="text-left">Acciones</th>
    </tr></thead><tbody>${rows}</tbody></table>`;
}
window.reabrirHist = function(id){
  const list = loadHist();
  const h = list.find(x=>x.id===id); if(!h) return alert('No encontrado');
  state.existencia = new Map(h.existencia||[]);
  state.scans = h.scans||[];
  state.groupedScans = new Map(h.groupedScans||[]);
  refreshUI();
  setStatusOk('Cargado desde histórico');
  document.querySelector('[data-tab="escanear"]').click();
};
window.exportHistJSON = function(id){
  const list=loadHist(); const h=list.find(x=>x.id===id); if(!h) return;
  const blob=new Blob([JSON.stringify(h,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`conteo_${(h.nombre||'sin_nombre')}.json`; a.click(); URL.revokeObjectURL(url);
};
window.exportHistCSV = function(id){
  const list=loadHist(); const h=list.find(x=>x.id===id); if(!h) return;
  exportCSV([['ESCANEADOS', new Map(h.groupedScans||[])], ['EXISTENCIA', new Map(h.existencia||[])]]);
};
window.borrarHist = function(id){
  const list = loadHist(); const i=list.findIndex(x=>x.id===id); if(i<0) return;
  if(!confirm('¿Eliminar conteo del historial?')) return;
  list.splice(i,1); saveHist(list); renderHist();
};
btnGuardarHistorico.addEventListener('click', ()=>{
  if (!state.scans.length && !state.existencia.size) { if(!confirm('No hay datos en este conteo. ¿Guardar de todos modos?')) return; }
  const snap = makeSnapshot();
  const list = loadHist(); list.push(snap); saveHist(list);
  renderHist(); setStatusOk('Guardado en histórico'); alert('Conteo guardado en histórico.\n\nPestaña 4) Historial.');
});
btnNuevaSesion.addEventListener('click', ()=>{
  if(!confirm('Esto limpia escaneos y existencia (no el catálogo). ¿Continuar?')) return;
  state.scans = []; state.groupedScans.clear(); state.existencia.clear();
  existenciaPreview.innerHTML=''; existenciaStatus.textContent='0 registros.';
  scanLog.innerHTML=''; scanGrouped.innerHTML='';
  saveLocal(); setStatusOk('Sesión nueva lista');
});

/* ---------------- Init ---------------- */
function init(){ loadLocal(); refreshUI(); listCameras(); renderHist(); listenSession(); }
init();
</script>
</body>
</html>
