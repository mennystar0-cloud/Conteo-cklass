<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Conteo CKLASS – Cíclicos con Folio</title>
<meta name="theme-color" content="#1877F2" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icons/icon-192.png" />
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --safe-bottom: env(safe-area-inset-bottom); --safe-top: env(safe-area-inset-top); }
  video { object-fit: cover; }
  @media print { .no-print { display:none!important; } }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  #quaggaOverlay { position:absolute; inset:0; pointer-events:none; }
  #quaggaArea { position: relative; background: #000; }
  .badge { display:inline-block; padding:.1rem .4rem; border-radius:.4rem; font-size:.75rem; }
  .cam-compact { height: 45vh; max-height: 420px; }
  .btn { padding:.5rem .75rem; font-size:.875rem; border-radius:.5rem; }
  .table th, .table td { border-bottom: 1px solid #e5e7eb; padding:.25rem .5rem; }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-4">
  <header class="mb-4 no-print">
    <h1 class="text-2xl font-bold">Módulo de Conteo – Catálogo fijo + Existencia por cíclico + Folio</h1>
    <p class="text-sm text-gray-600">Importar catálogo (1 vez) → Existencia (por cíclico) → Publicar/Compartir por <b>Folio</b> → Escanear.</p>
  </header>

  <!-- Tabs -->
  <div class="border-b border-gray-200 mb-4 no-print">
    <nav class="-mb-px flex gap-2" id="tabs">
      <button data-tab="importar" class="tab-btn border-b-2 border-blue-600 text-blue-600 px-4 py-2 text-sm font-medium">1) Importar</button>
      <button data-tab="escanear" class="tab-btn border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 px-4 py-2 text-sm font-medium">2) Escanear</button>
      <button data-tab="reporte" class="tab-btn border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 px-4 py-2 text-sm font-medium">3) Reporte</button>
      <button data-tab="historial" class="tab-btn border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 px-4 py-2 text-sm font-medium">4) Historial</button>
    </nav>
  </div>

  <!-- Importar -->
  <section id="tab-importar" class="tab-pane block">
    <div class="grid md:grid-cols-2 gap-4">
      <!-- Catálogo -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Catálogo maestro (CSV) — se carga 1 sola vez</h2>
        <p class="text-xs text-gray-600 mb-2">Columnas: <code>CODIGO_BARRA / EAN / UPC</code>, <code>MOD</code>, <code>COLOR</code>, <code>TALLA</code>, <code>TEMPORADA</code> (opcional)</p>
        <input id="fileCatalogo" type="file" accept=".csv" class="block w-full text-sm mb-2" />
        <div id="catalogoStatus" class="text-xs text-gray-600">Sin cargar.</div>

        <div class="flex flex-wrap gap-2 mt-2">
          <button id="btnUsarCatalogoGuardado" class="btn bg-emerald-600 text-white">Usar catálogo guardado</button>
          <button id="btnFijarCatalogo" class="btn bg-blue-600 text-white">Fijar como predeterminado</button>
          <button id="btnBorrarCatalogo" class="btn bg-red-600 text-white">Borrar guardado</button>
        </div>
        <div class="mt-2 flex gap-2">
          <input id="catalogoURL" class="border rounded p-2 text-xs flex-1" placeholder="URL CSV (GitHub/Firebase Storage)"/>
          <button id="btnCargarCatalogoURL" class="btn bg-gray-100">Cargar URL</button>
        </div>
        <div id="catalogoGuardadoStatus" class="text-xs text-gray-600 mt-1">—</div>
      </div>

      <!-- Existencia -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Existencia física (CSV) — por cíclico</h2>
        <p class="text-xs text-gray-600 mb-2">Formato: <code>MOD,COLOR,TALLA,CANTIDAD</code> o <code>CODIGO-COLOR-TALLA,CANTIDAD</code>. También acepta pegado como <code>000-24,NEGRO&nbsp;&nbsp;&nbsp;220&nbsp;&nbsp;&nbsp;4</code>.</p>
        <input id="fileExistenciaCSV" type="file" accept=".csv" class="block w-full text-sm mb-2" />
        <div id="existenciaCSVStatus" class="text-xs text-gray-600">Sin cargar.</div>

        <div class="bg-gray-50 rounded-xl p-2 mt-3">
          <label class="text-xs text-gray-600">Pegar existencia (opcional)</label>
          <textarea id="existenciaInput" rows="4" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="Ej: 000-24,NEGRO              220          4"></textarea>
          <div class="flex gap-2 mt-2">
            <button id="btnProcesarExistencia" class="btn bg-blue-600 text-white">Procesar</button>
            <button id="btnLimpiarExistencia" class="btn bg-gray-100">Limpiar</button>
          </div>
          <div class="text-xs text-gray-600 mt-2" id="existenciaStatus">0 registros.</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 mt-4">
      <h3 class="font-semibold mb-2">Vista previa existencia agrupada</h3>
      <div id="existenciaPreview" class="overflow-auto max-h-64 border rounded-xl"></div>
    </div>

    <!-- FOLIO: publicar y cargar -->
    <div class="bg-white rounded-2xl shadow p-4 mt-4">
      <h3 class="font-semibold mb-2">Folio de cíclico (nube)</h3>
      <div class="grid md:grid-cols-3 gap-2">
        <input id="folioInput" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Ej: DAM-OFERTA-2025-08-13" />
        <button id="btnPublicarFolio" class="btn bg-emerald-600 text-white">Publicar cíclico (subir a nube)</button>
        <button id="btnCargarFolio" class="btn bg-blue-600 text-white">Cargar folio (desde nube)</button>
      </div>
      <p class="text-xs text-gray-600 mt-2">Comparte el link con <code>?folio=TU-FOLIO</code> para que en celular se cargue solo.</p>
      <div id="folioStatus" class="text-xs text-gray-600 mt-1">—</div>
    </div>
  </section>

  <!-- Escanear -->
  <section id="tab-escanear" class="tab-pane hidden">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">Escaneo con cámara / Registro manual</h2>

      <!-- Metadatos -->
      <div class="grid md:grid-cols-4 gap-2 mb-3">
        <input id="metaNombre" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Nombre del conteo (o FOLIO)" />
        <input id="metaOperador" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Operador (p.ej. Fulanito XXXX)" />
        <input id="metaNotas" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Notas (opcional)" />
        <label class="inline-flex items-center gap-2 text-xs px-2">
          <input id="chkAutoReporte" type="checkbox" checked> Auto-reporte
        </label>
      </div>

      <div class="flex flex-wrap gap-2 mb-4">
        <button id="btnGuardarHistorico" class="btn bg-emerald-600 text-white">Guardar en histórico</button>
        <button id="btnNuevaSesion" class="btn bg-orange-500 text-white">Nueva sesión</button>
        <button id="btnAudio" class="btn bg-purple-600 text-white">Activar sonidos</button>
        <span id="lastStatus" class="badge bg-gray-100 text-gray-700">—</span>
      </div>

      <p class="text-xs text-gray-600 mb-3">HTTPS/localhost. Si no detecta, cambia a Quagga2. Usa Registro manual si no hay código o hay cantidad.</p>

      <div class="grid md:grid-cols-2 gap-4 mb-3">
        <!-- Manual -->
        <div>
          <label class="text-xs text-gray-500">Entrada con lector/teclado</label>
          <input id="scanInput" type="text" class="w-full rounded-xl border border-gray-200 p-3 mb-2" placeholder="Escanea o escribe: 10902400 ó 000-01,ORO-240 ó 000-01|ORO|240" />
          <div class="flex flex-wrap gap-2 mb-4">
            <button id="btnUndo" class="btn bg-gray-100">Deshacer</button>
            <button id="btnResetEscaneo" class="btn bg-gray-100">Reiniciar</button>
            <button id="btnCargarPruebaEscaneo" class="btn bg-gray-100">Prueba</button>
          </div>

          <div class="border-t pt-3 mt-2">
            <h3 class="font-semibold text-sm mb-2">Registrar manual</h3>
            <div class="grid grid-cols-5 gap-2 items-center">
              <input id="manualClave" class="col-span-3 rounded-lg border border-gray-200 p-2 text-sm" placeholder="Clave o código (MOD|COLOR|TALLA / 10902400)" />
              <input id="manualQty" type="number" min="1" value="1" class="col-span-1 rounded-lg border border-gray-200 p-2 text-sm" />
              <button id="btnManual" class="col-span-1 btn bg-blue-600 text-white">Registrar</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Acepta <b>MOD|COLOR|TALLA</b>, <b>MOD,COLOR-TALLA</b> o <b>código de barras</b>. Cantidad > 1 duplica el registro.</p>
          </div>
        </div>

        <!-- Cámara -->
        <div>
          <label class="text-xs text-gray-500">Cámara</label>
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <select id="cameraSelect" class="border rounded p-1 text-xs"></select>
            <select id="engineSelect" class="border rounded p-1 text-xs">
              <option value="bd">Barcode Detector (rápido)</option>
              <option value="quagga">Quagga2 (compatibilidad)</option>
            </select>
            <button id="btnSolicitarPermisos" class="btn bg-indigo-600 text-white">Permisos</button>
            <button id="btnCamStart" class="btn bg-green-600 text-white">Iniciar</button>
            <button id="btnCamStop" class="btn bg-gray-100">Detener</button>
            <button id="btnTogglePause" class="btn bg-yellow-500 text-white">Pausar escaneo</button>
            <label class="flex items-center gap-2 text-xs ml-2"><input id="chkAuto" type="checkbox" checked> Auto-agregar</label>
            <label class="flex items-center gap-2 text-xs ml-2"><input id="chkBeep" type="checkbox" checked> Beep</label>
            <button id="btnTorch" class="btn bg-gray-100">Linterna</button>
            <button id="btnFullscreen" class="btn bg-gray-100">Pantalla completa</button>
          </div>
          <div class="text-xs" id="httpsStatus"></div>

          <div id="quaggaArea" class="cam-compact rounded-xl border border-gray-200 overflow-hidden bg-black mt-2">
            <video id="videoCam" class="w-full h-full" autoplay playsinline muted></video>
            <canvas id="quaggaOverlay"></canvas>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <h3 class="font-semibold mb-2">Últimos escaneos (local)</h3>
          <div id="scanLog" class="overflow-auto max-h-64 border rounded-xl"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Acumulado por clave (local)</h3>
          <div id="scanGrouped" class="overflow-auto max-h-64 border rounded-xl"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Feed en vivo (Firestore)</h3>
          <div id="liveFeed" class="overflow-auto max-h-64 border rounded-xl">
            <table class="min-w-full text-xs table">
              <thead><tr><th class="text-left">Hora</th><th class="text-left">Clave</th><th class="text-left">Operador</th><th class="text-left">Dispositivo</th></tr></thead>
              <tbody id="liveFeedBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="mt-3 text-xs text-gray-500 mono" id="diag"></div>
    </div>
  </section>

  <!-- Reporte -->
  <section id="tab-reporte" class="tab-pane hidden">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">Reporte (Escaneados vs Existencia)</h2>
      <div class="flex flex-wrap gap-2 mb-3 no-print">
        <button id="btnGenerarReporte" class="btn bg-blue-600 text-white">Generar</button>
        <button id="btnExportarCSV" class="btn bg-gray-100">Exportar CSV</button>
        <button id="btnRespaldarJSON" class="btn bg-gray-100">Respaldo JSON</button>
        <button id="btnImprimir" class="btn bg-gray-100" onclick="window.print()">Imprimir</button>
      </div>
      <div class="bg-gray-50 border rounded-xl p-3 mb-3 no-print">
        <h3 class="font-semibold mb-2">Filtros</h3>
        <div class="grid md:grid-cols-4 gap-2">
          <input id="filtroMOD" placeholder="Filtrar MOD" class="rounded-lg border border-gray-200 p-2 text-sm"/>
          <input id="filtroCOLOR" placeholder="Filtrar COLOR" class="rounded-lg border border-gray-200 p-2 text-sm"/>
          <input id="filtroTALLA" placeholder="Filtrar TALLA" class="rounded-lg border border-gray-200 p-2 text-sm"/>
          <input id="filtroTEMP" placeholder="Filtrar TEMPORADA" class="rounded-lg border border-gray-200 p-2 text-sm"/>
        </div>
      </div>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Escaneados</h3>
          <div id="tablaEscaneados" class="overflow-auto max-h-80"></div>
        </div>
        <div class="border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Sobrantes</h3>
          <div id="tablaSobrantes" class="overflow-auto max-h-80"></div>
        </div>
        <div class="border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Faltantes</h3>
          <div id="tablaFaltantes" class="overflow-auto max-h-80"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Historial local -->
  <section id="tab-historial" class="tab-pane hidden">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-3">Historial de conteos (local)</h2>
      <div id="histList" class="overflow-auto max-h-[70vh] border rounded-xl"></div>
      <div class="text-xs text-gray-500 mt-2">Se guarda en <code>localStorage</code>. Para multi-dispositivo, usa el mismo “Nombre del conteo” con Firebase configurado.</div>
    </div>
  </section>

  <footer class="mt-6 text-xs text-gray-500 no-print">
    Catálogo persistente en IndexedDB. Existencia por cíclico. Firestore/Storage activos.  
    Claves locales: <code>conteo_cklass_v01</code>, <code>conteo_cklass_hist</code>.
  </footer>
</div>

<!-- Quagga2 -->
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<!-- ============== Código principal ============== -->
<script type="module">
/* ---------------- Tabs ---------------- */
(() => {
  try {
    const tabs = document.querySelectorAll('.tab-btn');
    const panes = {
      importar: document.getElementById('tab-importar'),
      escanear: document.getElementById('tab-escanear'),
      reporte: document.getElementById('tab-reporte'),
      historial: document.getElementById('tab-historial'),
    };
    function activate(tab) {
      tabs.forEach(b => {
        b.classList.toggle('text-blue-600', b.dataset.tab===tab);
        b.classList.toggle('border-blue-600', b.dataset.tab===tab);
      });
      Object.entries(panes).forEach(([k, el]) => {
        el.classList.toggle('hidden', k !== tab);
        el.classList.toggle('block', k === tab);
      });
      location.hash = '#'+tab;
    }
    tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));
    window.addEventListener('hashchange', () => activate((location.hash||'#importar').slice(1)));
    activate((location.hash||'#importar').slice(1));
  } catch (e) { console.error('Tabs error', e); }
})();

/* ---------------- Firebase (CDN v12.1.0) ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

/* >>>>>>>>>>>> Config tuya <<<<<<<<<<<<< */
const firebaseConfig = {
  apiKey: "AIzaSyBGUDLrMfj-8GAJMemkfcHAGmGucMyKKzA",
  authDomain: "cklass-conteo.firebaseapp.com",
  projectId: "cklass-conteo",
  storageBucket: "cklass-conteo.firebasestorage.app",
  messagingSenderId: "695313165938",
  appId: "1:695313165938:web:26f2b2f7276968a1ccdceb",
  measurementId: "G-45LC81EE44"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------------- Estado/refs ---------------- */
const QUIRKS = { cameraActive:false, track:null, torchOn:false };
const state = {
  catalog:new Map(),       // BC -> {MOD,COLOR,TALLA,TEMPORADA}
  indexByKey:new Map(),    // KEY -> [BC]
  keyMeta:new Map(),       // KEY -> {MOD,COLOR,TALLA,TEMPORADA}
  existencia:new Map(),    // KEY -> cantidad (del archivo de existencia)
  scans:[],                // lista de KEY escaneadas (local)
  groupedScans:new Map()   // KEY -> cantidad
};
let SCAN_PAUSED = false;
const deviceId = (localStorage.getItem('conteo_device_id') || (crypto.randomUUID?.() || String(Math.random()).slice(2)));
localStorage.setItem('conteo_device_id', deviceId);
const processedNonces = new Set();

/* ---------------- Elementos ---------------- */
const els = {
  // importar
  fileCatalogo: document.getElementById('fileCatalogo'), catalogoStatus:document.getElementById('catalogoStatus'),
  catalogoURL:document.getElementById('catalogoURL'), btnCargarCatalogoURL:document.getElementById('btnCargarCatalogoURL'),
  btnUsarCatalogoGuardado:document.getElementById('btnUsarCatalogoGuardado'), btnFijarCatalogo:document.getElementById('btnFijarCatalogo'), btnBorrarCatalogo:document.getElementById('btnBorrarCatalogo'),
  catalogoGuardadoStatus:document.getElementById('catalogoGuardadoStatus'),

  fileExistenciaCSV: document.getElementById('fileExistenciaCSV'), existenciaCSVStatus:document.getElementById('existenciaCSVStatus'),
  existenciaInput: document.getElementById('existenciaInput'), btnProcesarExistencia:document.getElementById('btnProcesarExistencia'), btnLimpiarExistencia:document.getElementById('btnLimpiarExistencia'),
  existenciaStatus: document.getElementById('existenciaStatus'), existenciaPreview: document.getElementById('existenciaPreview'),

  // FOLIO
  folioInput: document.getElementById('folioInput'), btnPublicarFolio: document.getElementById('btnPublicarFolio'), btnCargarFolio: document.getElementById('btnCargarFolio'), folioStatus: document.getElementById('folioStatus'),

  // escanear
  scanInput: document.getElementById('scanInput'), scanLog: document.getElementById('scanLog'), scanGrouped: document.getElementById('scanGrouped'),
  btnUndo: document.getElementById('btnUndo'), btnResetEscaneo: document.getElementById('btnResetEscaneo'), btnCargarPruebaEscaneo: document.getElementById('btnCargarPruebaEscaneo'),
  cameraSelect: document.getElementById('cameraSelect'), engineSelect: document.getElementById('engineSelect'),
  btnSolicitarPermisos:document.getElementById('btnSolicitarPermisos'),
  btnCamStart: document.getElementById('btnCamStart'), btnCamStop:document.getElementById('btnCamStop'), btnFullscreen:document.getElementById('btnFullscreen'),
  btnTorch: document.getElementById('btnTorch'), btnTogglePause: document.getElementById('btnTogglePause'),
  httpsStatus:document.getElementById('httpsStatus'), videoCam:document.getElementById('videoCam'), diag: document.getElementById('diag'),
  chkAuto: document.getElementById('chkAuto'), chkBeep: document.getElementById('chkBeep'), chkAutoReporte: document.getElementById('chkAutoReporte'),
  quaggaOverlay: document.getElementById('quaggaOverlay'), quaggaArea: document.getElementById('quaggaArea'),
  manualClave: document.getElementById('manualClave'), manualQty: document.getElementById('manualQty'), btnManual: document.getElementById('btnManual'),
  lastStatus: document.getElementById('lastStatus'), btnAudio: document.getElementById('btnAudio'),
  metaNombre: document.getElementById('metaNombre'), metaOperador: document.getElementById('metaOperador'), metaNotas: document.getElementById('metaNotas'),
  btnGuardarHistorico: document.getElementById('btnGuardarHistorico'), btnNuevaSesion: document.getElementById('btnNuevaSesion'),
  liveFeedBody: document.getElementById('liveFeedBody'),

  // reporte
  btnGenerarReporte: document.getElementById('btnGenerarReporte'), btnExportarCSV:document.getElementById('btnExportarCSV'), btnRespaldarJSON:document.getElementById('btnRespaldarJSON'),
  tablaEscaneados: document.getElementById('tablaEscaneados'), tablaSobrantes:document.getElementById('tablaSobrantes'), tablaFaltantes: document.getElementById('tablaFaltantes'),
  filtroMOD: document.getElementById('filtroMOD'), filtroCOLOR: document.getElementById('filtroCOLOR'), filtroTALLA: document.getElementById('filtroTALLA'), filtroTEMP: document.getElementById('filtroTEMP'),

  // historial
  histList: document.getElementById('histList')
};

/* ---------------- HTTPS check ---------------- */
function updateHttpsStatus(){
  const isSecure = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
  els.httpsStatus.innerHTML = isSecure
    ? '<span class="text-green-700">Contexto seguro ✔ (HTTPS/localhost).</span>'
    : `<span class="text-red-700">Contexto NO seguro ✖ (${location.protocol}).</span>`;
}
updateHttpsStatus();

/* ---------------- Sonidos WebAudio ---------------- */
let audioCtx = null, audioReady = false;
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); audioReady = true; playTone(900, 60, 'square', 0.06); }
function playTone(freq=880, ms=90, type='sine', gain=0.08) { if (!audioReady || !audioCtx) return; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = type; osc.frequency.value = freq; g.gain.value = gain; osc.connect(g).connect(audioCtx.destination); const now = audioCtx.currentTime; osc.start(now); osc.stop(now + ms/1000); }
function playOk(){ if(!els.chkBeep.checked) return; playTone(1200, 90, 'square', 0.08); }
function playErr(){ playTone(220, 140, 'sawtooth', 0.10); }
function buzz(pattern=[120]){ if (navigator.vibrate) navigator.vibrate(pattern); }
els.btnAudio.addEventListener('click', initAudio);
const _unlock = ()=>{ initAudio(); document.removeEventListener('click', _unlock); document.removeEventListener('keydown', _unlock); };
document.addEventListener('click', _unlock, { once:true });
document.addEventListener('keydown', _unlock, { once:true });

/* ---------------- Utilidades generales ---------------- */
const toKey = (mod, color, talla) => `${(mod||'').trim()}|${(color||'').trim()}|${(talla||'').trim()}`.toUpperCase();
function renderTable(map, headers=['Clave','Cantidad']){
  const rows=[...map.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  return ['<table class="min-w-full text-sm">', `<thead><tr>${headers.map(h=>`<th class="text-left px-2 py-1 border-b">${h}</th>`).join('')}</tr></thead>`, '<tbody>',
    ...rows.map(([k,v])=>`<tr><td class="px-2 py-1 border-b">${k}</td><td class="px-2 py-1 border-b">${v}</td></tr>`), '</tbody></table>'].join('');
}
function renderLog(list){ const last=list.slice(-50).reverse(); return ['<table class="min-w-full text-xs table"><thead><tr><th>#</th><th>Entrada</th></tr></thead><tbody>', ...last.map((x,i)=>`<tr><td>${last.length-i}</td><td>${x}</td></tr>`), '</tbody></table>'].join(''); }
function group(list){ const m=new Map(); for(const k of list) if(!k.startsWith||!k.startsWith('[NO ENCONTRADO]')) m.set(k,(m.get(k)||0)+1); return m; }
function exportCSV(sections){ let csv='SECCION,CLAVE,CANTIDAD\n'; for(const [name,map] of sections) for(const [k,v] of map.entries()) csv+=`${name},"${k.replaceAll('"','""')}",${v}\n`; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='reporte_conteo.csv'; a.click(); URL.revokeObjectURL(url); }
function saveLocal(){ const d={catalog:[...state.catalog], indexByKey:[...state.indexByKey], keyMeta:[...state.keyMeta], existencia:[...state.existencia], scans:state.scans, v:'hist-fb-v2'}; localStorage.setItem('conteo_cklass_v01', JSON.stringify(d)); }
function loadLocal(){ const raw=localStorage.getItem('conteo_cklass_v01'); if(!raw) return; try{ const d=JSON.parse(raw); state.catalog=new Map(d.catalog||[]); state.indexByKey=new Map(d.indexByKey||[]); state.keyMeta=new Map(d.keyMeta||[]); state.existencia=new Map(d.existencia||[]); state.scans=d.scans||[]; state.groupedScans=group(state.scans);}catch(e){} }
function refreshUI(){ els.catalogoStatus.textContent=`${state.catalog.size} códigos de barras cargados.`; els.existenciaStatus.textContent=`${state.existencia.size} claves agrupadas.`; els.existenciaPreview.innerHTML=renderTable(state.existencia); els.scanLog.innerHTML=renderLog(state.scans); els.scanGrouped.innerHTML=renderTable(state.groupedScans); }
function setStatusOk(msg='OK'){ els.lastStatus.textContent=msg; els.lastStatus.className='badge bg-green-100 text-green-700'; }
function setStatusErr(msg='ERROR'){ els.lastStatus.textContent=msg; els.lastStatus.className='badge bg-red-100 text-red-700'; }

/* ===== CSV utils ===== */
function splitCSVLine(line) {
  const result = []; let current = '', inQuotes = false;
  for (let i=0;i<line.length;i++) {
    const ch=line[i];
    if (ch === '"') { if (inQuotes && line[i+1] === '"') { current+='"'; i++; } else { inQuotes=!inQuotes; } }
    else if (ch === ',' && !inQuotes) { result.push(current); current=''; }
    else { current += ch; }
  }
  result.push(current);
  return result;
}
function norm(s){ return (s==null?'':String(s)).replace(/^\uFEFF/,'').trim(); }
function findCol(cols, candidates) {
  const map = new Map(cols.map((c,i)=>[c.trim().toUpperCase(), i]));
  for (const name of candidates) { const i = map.get(name.toUpperCase()); if (i !== undefined) return i; }
  return -1;
}

/* ===== Catálogo: procesar + persistir ===== */
function procesarCatalogoDesdeTexto(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
  if (!lines.length) { els.catalogoStatus.textContent = 'Archivo vacío.'; return false; }
  const header = splitCSVLine(lines.shift()).map(x => norm(x).toUpperCase());
  const idxBC    = findCol(header, ['CODIGO_BARRA','CODIGOBARRA','CODIGO','EAN','UPC','BARRA','BARRAS','COD_BARRAS','CODBAR','BARCODE']);
  const idxMOD   = findCol(header, ['MOD','MODELO','SKU','ARTICULO','ITEM','REFERENCIA']);
  const idxCOLOR = findCol(header, ['COLOR','COL','CLR']);
  const idxTALLA = findCol(header, ['TALLA','SIZE','NUMERACION']);
  const idxTEMP  = findCol(header, ['TEMPORADA','TEMP','TEMPORALIDAD','SEASON']);
  if (idxBC === -1) { alert('No se encontró columna de CÓDIGO DE BARRAS.'); return false; }

  state.catalog.clear(); state.indexByKey.clear(); state.keyMeta.clear();
  let conClave = 0, soloBC = 0;
  for (const line of lines) {
    const parts = splitCSVLine(line);
    const bc   = norm(parts[idxBC]); if (!bc) continue;
    const MOD   = idxMOD   >= 0 ? norm(parts[idxMOD])   : '';
    const COLOR = idxCOLOR >= 0 ? norm(parts[idxCOLOR]) : '';
    const TALLA = idxTALLA >= 0 ? norm(parts[idxTALLA]) : '';
    const TEMP  = idxTEMP  >= 0 ? norm(parts[idxTEMP])  : '';
    state.catalog.set(bc, { MOD, COLOR, TALLA, TEMPORADA: TEMP });
    if (MOD || COLOR || TALLA) {
      const key = `${MOD.toUpperCase()}|${COLOR.toUpperCase()}|${TALLA.toUpperCase()}`;
      if (!state.indexByKey.has(key)) state.indexByKey.set(key, []);
      state.indexByKey.get(key).push(bc);
      if (!state.keyMeta.has(key)) state.keyMeta.set(key, { MOD, COLOR, TALLA, TEMPORADA: TEMP });
      conClave++;
    } else { soloBC++; }
  }
  els.catalogoStatus.textContent = `${state.catalog.size} códigos cargados. ${(conClave?conClave+' con clave. ':'')}${(soloBC?soloBC+' solo BC.':'')}`;
  saveLocal(); refreshUI(); return true;
}

/* ===== Importar catálogo ===== */
els.fileCatalogo.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  const ok = procesarCatalogoDesdeTexto(text);
  if (ok) els.catalogoGuardadoStatus.textContent='Catálogo cargado (no persistido aún).';
});
els.btnCargarCatalogoURL.addEventListener('click', async ()=>{
  const url = els.catalogoURL.value.trim();
  if (!url) return alert('URL vacío.');
  try{
    const resp = await fetch(url, { cache:'no-store' });
    if (!resp.ok) throw new Error('HTTP '+resp.status);
    const text = await resp.text();
    const ok = procesarCatalogoDesdeTexto(text);
    if (ok) els.catalogoGuardadoStatus.textContent='Catálogo cargado desde URL (no persistido aún).';
  }catch(e){
    alert('No se pudo descargar el CSV: '+(e?.message||e));
  }
});

/* ===== IndexedDB catálogo ===== */
const IDB_NAME='cklass-db', IDB_STORE='catalog';
function idbOpen(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open(IDB_NAME,1);
    req.onupgradeneeded = ()=>{ req.result.createObjectStore(IDB_STORE); };
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
function txDone(tx){ return new Promise((res,rej)=>{ tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.onabort=()=>rej(tx.error); }); }
async function idbSet(key,val){ const db=await idbOpen(); const tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).put(val, key); await txDone(tx); db.close(); }
async function idbGet(key){ const db=await idbOpen(); const tx=db.transaction(IDB_STORE,'readonly'); const req=tx.objectStore(IDB_STORE).get(key); const val=await new Promise(r=>{ req.onsuccess=()=>r(req.result); req.onerror=()=>r(null); }); db.close(); return val; }
async function idbDel(key){ const db=await idbOpen(); const tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).delete(key); await txDone(tx); db.close(); }

async function persistCatalog(){
  if (!state.catalog.size) return alert('Carga primero un catálogo.');
  const payload = { catalog: [...state.catalog], indexByKey: [...state.indexByKey], keyMeta: [...state.keyMeta], savedAt: Date.now() };
  await idbSet('catalog_v1', payload);
  els.catalogoGuardadoStatus.textContent = 'Catálogo guardado localmente (IndexedDB).';
}
async function loadPersistedCatalog(){
  const p = await idbGet('catalog_v1');
  if (!p) { els.catalogoGuardadoStatus.textContent='Sin catálogo guardado.'; return false; }
  state.catalog = new Map(p.catalog||[]);
  state.indexByKey = new Map(p.indexByKey||[]);
  state.keyMeta = new Map(p.keyMeta||[]);
  refreshUI();
  els.catalogoGuardadoStatus.textContent='Usando catálogo guardado (IndexedDB).';
  return true;
}
async function deletePersistedCatalog(){
  await idbDel('catalog_v1');
  els.catalogoGuardadoStatus.textContent='Catálogo guardado eliminado.';
}
els.btnFijarCatalogo.addEventListener('click', persistCatalog);
els.btnUsarCatalogoGuardado.addEventListener('click', loadPersistedCatalog);
els.btnBorrarCatalogo.addEventListener('click', deletePersistedCatalog);

/* ===== Existencia: archivo o pegado ===== */
els.fileExistenciaCSV.addEventListener('change', async (e)=>{ const text=await e.target.files?.[0]?.text(); if(!text) return; parseExistenciaCSV(text); saveLocal(); refreshUI(); });

/* PEGADO de existencia robusto (incluye "000-24,NEGRO      220      4") */
els.btnProcesarExistencia.addEventListener('click',()=>{
  const acc = new Map(); const notFound = [];
  function addKey(key, qty=1){
    if(!key) return;
    acc.set(key, (acc.get(key)||0) + (qty||0));
    if(!state.keyMeta.has(key)){ const [MOD,COLOR,TALLA]=key.split('|'); state.keyMeta.set(key,{MOD,COLOR,TALLA,TEMPORADA:''}); }
  }
  els.existenciaInput.value.split(/\r?\n/).forEach(raw=>{
    let line = (raw||'').trim(); if(!line) return;
    line = line.replace(/\s{2,}/g, ' ').replace(/\s*-\s*/g,'-'); // normaliza espacios y guiones
    if(/^\d{6,}$/.test(line)){ const item = state.catalog.get(line); if(!item){ notFound.push(line); return; } addKey(toKey(item.MOD,item.COLOR,item.TALLA), 1); return; }
    let m = line.match(/^([^,]+),(.+?)\s+(\S+)\s+(\d+)\s*$/);
    if(m){ addKey(toKey(m[1].trim(), m[2].trim(), m[3].trim()), parseInt(m[4],10)||0); return; }
    m = line.match(/^([^|]+)\|([^|]+)\|([^\|,]+)(?:\s*,\s*(\d+))?$/);
    if(m){ addKey(toKey(m[1],m[2],m[3]), parseInt(m[4]||'1',10)||1); return; }
    m = line.match(/^([^,]+)\s*,\s*([^-\s][^-]*?)\s*-\s*([^\s,]+)(?:\s*,\s*(\d+))?$/);
    if(m){ addKey(toKey(m[1],m[2],m[3]), parseInt(m[4]||'1',10)||1); return; }
    const parts = line.split(',').map(s=>s.trim());
    if(parts.length>=4){ const [MOD,COLOR,TALLA,CANT]=parts; if(MOD&&COLOR&&TALLA){ addKey(toKey(MOD,COLOR,TALLA), parseInt(CANT,10)||0); return; } }
    notFound.push('FORMATO_NO_RECONOCIDO: '+line);
  });
  state.existencia = acc;
  els.existenciaStatus.textContent = `${state.existencia.size} claves agrupadas.` + (notFound.length?` Avisos: ${notFound.length}`:'');
  els.existenciaPreview.innerHTML = renderTable(state.existencia);
  saveLocal();
});

/* >>>>>>>>>>>>>>> PARCHE: Limpiar existencia (reseteo total) <<<<<<<<<<<<<<< */
els.btnLimpiarExistencia.addEventListener('click', () => {
  els.existenciaInput.value = '';
  state.existencia = new Map();
  els.existenciaPreview.innerHTML = '';
  els.existenciaStatus.textContent = '0 registros.';
  els.existenciaCSVStatus.textContent = 'Sin cargar.';
  saveLocal();
  refreshUI();
});

/* >>>>>>>>>>>>>>> PARCHE: parseExistenciaCSV robusto (bug fijo) <<<<<<<<<<<<<<< */
function parseExistenciaCSV(text){
  const textNorm = (text||'').replace(/\uFEFF/g,'').replace(/;/g, ',');
  const lines = textNorm.split(/\r?\n/).filter(l => l.trim().length);
  if (!lines.length) { els.existenciaCSVStatus.textContent = 'Archivo vacío.'; return; }

  const header = splitCSVLine(lines[0]).map(x => norm(x).toUpperCase());
  const idxKEY   = findCol(header, ['CODIGO-COLOR-TALLA','CLAVE','KEY']);
  const idxMOD   = findCol(header, ['MOD','MODELO','SKU','ARTICULO','ITEM','REFERENCIA']);
  const idxCOLOR = findCol(header, ['COLOR','COL','CLR']);
  const idxTALLA = findCol(header, ['TALLA','SIZE','NUMERACION']);
  let   idxCANT  = findCol(header, ['CANTIDAD','QTY','STOCK','EXISTENCIA','CANT']);

  const acc = new Map();

  if (idxKEY >= 0 || (idxMOD >= 0 && idxCOLOR >= 0 && idxTALLA >= 0)) {
    lines.shift(); // consume encabezado
    for (const line of lines) {
      if (!line.trim()) continue;
      const p = splitCSVLine(line).map(norm);
      let key = '';

      if (idxMOD >= 0 && idxCOLOR >= 0 && idxTALLA >= 0) {
        const MOD = p[idxMOD] || '';
        const COLOR = p[idxCOLOR] || '';
        const TALLA = p[idxTALLA] || ''; // <-- fix real
        key = toKey(MOD, COLOR, TALLA);
      } else if (idxKEY >= 0 && p[idxKEY]) {
        const raw = p[idxKEY].trim();
        if (raw.includes('|')) {
          const [m,c,t] = raw.split('|').map(norm);
          key = toKey(m,c,t);
        } else if (raw.includes(',')) {
          const [m, tail] = raw.split(',');
          const [c, t] = (tail||'').split('-');
          key = toKey(m,c,t);
        } else if (raw.includes('-')) {
          const [m,c,t] = raw.split('-').map(norm);
          key = toKey(m,c,t);
        }
      }

      let qty = 1;
      if (idxCANT >= 0) qty = parseInt(p[idxCANT]||'1', 10) || 0;

      if (!key) continue;
      acc.set(key, (acc.get(key)||0) + qty);
      if (!state.keyMeta.has(key)) {
        const [M,C,T] = key.split('|');
        state.keyMeta.set(key, { MOD:M, COLOR:C, TALLA:T, TEMPORADA:'' });
      }
    }
  } else {
    // Fallback sin encabezado: "000-24,NEGRO      220      4"
    for (const raw of lines) {
      const line = (raw||'').trim();
      if (!line) continue;
      let m = line.match(/^([^,]+),(.+?)\s+(\S+)\s+(\d+)\s*$/);
      if (m) {
        const key = toKey(m[1], m[2], m[3]);
        const qty = parseInt(m[4],10) || 0;
        acc.set(key, (acc.get(key)||0) + qty);
        if (!state.keyMeta.has(key)) {
          const [M,C,T] = key.split('|');
          state.keyMeta.set(key, { MOD:M, COLOR:C, TALLA:T, TEMPORADA:'' });
        }
      }
    }
  }

  if (acc.size) {
    state.existencia = acc;
    els.existenciaCSVStatus.textContent = `${state.existencia.size} claves cargadas.`;
    els.existenciaStatus.textContent = `${state.existencia.size} claves agrupadas.`;
    els.existenciaPreview.innerHTML = renderTable(state.existencia);
  } else {
    els.existenciaCSVStatus.textContent = `No se pudo leer el archivo de existencia.`;
    els.existenciaStatus.textContent = `0 registros.`;
    els.existenciaPreview.innerHTML = '';
  }

  saveLocal();
  refreshUI();
}

/* ===== Folio: publicar/cargar (Firestore + Storage) ===== */
function mapToCSV(map, headers=['CLAVE','CANTIDAD']) {
  let out = headers.join(',') + '\n'; for (const [k,v] of map.entries()) out += `"${k.replaceAll('"','""')}",${v}\n`; return out;
}
function catalogToCSV(){
  let out='CODIGO_BARRA,MOD,COLOR,TALLA,TEMPORADA\n';
  for (const [bc, o] of state.catalog.entries()) out += `${bc},${o.MOD||''},${o.COLOR||''},${o.TALLA||''},${o.TEMPORADA||''}\n`;
  return out;
}
async function uploadText(path, text){
  const storageRef = ref(storage, path);
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
  await uploadBytes(storageRef, blob);
  return await getDownloadURL(storageRef);
}
async function publicarFolio(folio){
  folio = (folio||'').trim();
  if (!folio) throw new Error('Folio vacío.');
  if (!state.catalog.size) throw new Error('Carga primero el Catálogo.');
  if (!state.existencia.size) throw new Error('Carga o pega la Existencia.');
  const ver = Date.now();
  const catCSV = catalogToCSV();
  const exCSV  = mapToCSV(state.existencia, ['CLAVE','CANTIDAD']);
  const catUrl = await uploadText(`ciclos/${folio}/catalogo_${ver}.csv`, catCSV);
  const exUrl  = await uploadText(`ciclos/${folio}/existencia_${ver}.csv`, exCSV);
  const cfg = { folio, version: ver, catalogUrl: catUrl, existenciaUrl: exUrl, ts: new Date().toISOString() };
  await setDoc(doc(db, 'ciclos', folio), cfg);
  return cfg;
}
async function cargarDesdeFolio(folio){
  folio = (folio||'').trim(); if (!folio) throw new Error('Folio vacío.');
  const snap = await getDoc(doc(db, 'ciclos', folio));
  if (!snap.exists()) throw new Error('Folio no encontrado.');
  const cfg = snap.data();
  if (cfg.catalogUrl) { const t = await (await fetch(cfg.catalogUrl, {cache:'no-store'})).text(); const ok = procesarCatalogoDesdeTexto(t); if (ok) await persistCatalog(); }
  if (cfg.existenciaUrl) { const t2 = await (await fetch(cfg.existenciaUrl, {cache:'no-store'})).text(); parseExistenciaCSV(t2); }
  refreshUI();
  els.metaNombre.value = folio; // que todos escaneen al mismo folio
  listenSession();
  return cfg;
}
els.btnPublicarFolio?.addEventListener('click', async ()=>{
  try{
    els.folioStatus.textContent = 'Publicando...';
    const folio = els.folioInput.value;
    const cfg = await publicarFolio(folio);
    els.folioStatus.textContent = `Publicado ✔ Versión ${cfg.version}.`;
    alert('Publicado.\n\nComparte este link:\n' + location.origin + location.pathname + '?folio=' + encodeURIComponent(folio));
  }catch(e){
    els.folioStatus.textContent = 'Error: ' + (e?.message||e);
    alert('Error al publicar: ' + (e?.message||e));
  }
});
els.btnCargarFolio?.addEventListener('click', async ()=>{
  try{
    els.folioStatus.textContent = 'Cargando folio...';
    const folio = els.folioInput.value;
    const cfg = await cargarDesdeFolio(folio);
    els.folioStatus.textContent = `Folio cargado ✔ Versión ${cfg.version}. Listo para escanear.`;
  }catch(e){
    els.folioStatus.textContent = 'Error: ' + (e?.message||e);
    alert('Error al cargar folio: ' + (e?.message||e));
  }
});
function getParam(name){ try{ return new URL(location.href).searchParams.get(name); }catch(_){ return null; } }
async function bootFromFolioParam(){
  const folio = getParam('folio');
  if (!folio) return;
  try{
    els.folioInput.value = folio;
    els.folioStatus.textContent = 'Cargando folio desde URL...';
    const cfg = await cargarDesdeFolio(folio);
    els.folioStatus.textContent = `Folio cargado ✔ Versión ${cfg.version}.`;
  }catch(e){
    els.folioStatus.textContent = 'Error: ' + (e?.message||e);
  }
}

/* ===== Escaneo/Manual ===== */
els.scanInput.addEventListener('keydown',(e)=>{ if(e.key!=='Enter') return; const line=e.target.value.trim(); e.target.value=''; if(!line) return; addScanLine(line); });
function addScanLine(line){
  let key=null;
  if(/^\d{6,}$/.test(line)){ const item=state.catalog.get(line); if(!item){ setStatusErr('BC no existe'); playErr(); buzz([70]); alert('Código no encontrado en catálogo: '+line); return; } key=toKey(item.MOD,item.COLOR,item.TALLA); }
  else if(line.includes('|')){ const [m,c,t]=line.split('|').map(s=>s.trim()); if(!m||!c||!t){ setStatusErr('Entrada inválida'); playErr(); return; } key=toKey(m,c,t); }
  else if(line.includes(',')){ const [mod,tail]=line.split(','); if(!mod||!tail){ setStatusErr('Entrada inválida'); playErr(); return; } if(tail.includes('-')){const [color,talla]=tail.split('-'); key=toKey(mod,color,talla);} }
  else { setStatusErr('Entrada inválida'); playErr(); return; }
  registerKey(key);
}

/* Botones manuales */
els.btnManual.addEventListener('click', ()=>{
  const clave = (els.manualClave.value||'').trim();
  let qty = parseInt((els.manualQty.value||'1'),10); if(!qty || qty<1) qty=1;
  if(!clave){ setStatusErr('Entrada vacía'); playErr(); buzz([70]); return; }
  let key=null;
  if(/^\d{6,}$/.test(clave)){
    const item = state.catalog.get(clave);
    if(!item){ setStatusErr('BC no existe'); playErr(); buzz([70]); alert('Código no encontrado en catálogo: '+clave); return; }
    key = toKey(item.MOD,item.COLOR,item.TALLA);
  } else if(clave.includes('|')) {
    const [m,c,t]=clave.split('|').map(s=>s.trim()); if(!m||!c||!t){ setStatusErr('Entrada inválida'); playErr(); return; } key=toKey(m,c,t);
  } else if(clave.includes(',')) {
    const [mod,tail]=clave.split(','); if(!mod||!tail){ setStatusErr('Entrada inválida'); playErr(); return; } if(tail.includes('-')){const [color,talla]=tail.split('-'); key=toKey(mod,color,talla);}
  } else { setStatusErr('Entrada inválida'); playErr(); return; }
  for(let i=0;i<qty;i++) registerKey(key);
  els.manualClave.value=''; els.manualQty.value='1';
});

/* Antirrebote cámara */
const FRAME_COOLDOWN_MS = 220;
const SAME_CODE_COOLDOWN_MS = 1800;
let lastFrameAt = 0;
const seenRecently = new Map();
function canAccept(code){
  const now = Date.now();
  if (now - lastFrameAt < FRAME_COOLDOWN_MS) return false;
  lastFrameAt = now;
  const last = seenRecently.get(code) || 0;
  if (now - last < SAME_CODE_COOLDOWN_MS) return false;
  seenRecently.set(code, now);
  for (const [c,t] of seenRecently) if (now - t > SAME_CODE_COOLDOWN_MS*3) seenRecently.delete(c);
  return true;
}

/* Cámara: BD/Quagga */
const supportsBarcode = "BarcodeDetector" in window;
let detector = supportsBarcode ? new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','itf','codabar']}) : null;
let camStream=null, detectLoop=null, quaggaActive=false;

function log(msg){ els.diag.textContent = (msg+"\n") + els.diag.textContent; }
async function listCameras(){
  try{
    const devices=await navigator.mediaDevices.enumerateDevices();
    const vids=devices.filter(d=>d.kind==='videoinput');
    els.cameraSelect.innerHTML = vids.map((d,i)=>`<option value="${d.deviceId}">${d.label || 'Cámara '+(i+1)}</option>`).join('');
    log('Videoinputs: '+vids.length);
  }catch(e){ els.cameraSelect.innerHTML='<option value="">Cámara predeterminada</option>'; log('enumerateDevices error: '+e.message); }
}
navigator.mediaDevices?.enumerateDevices && listCameras();

els.btnSolicitarPermisos.addEventListener('click', async ()=>{
  updateHttpsStatus();
  try{
    const tmp = await navigator.mediaDevices.getUserMedia({ video: { facingMode: {ideal:'environment'} }, audio:false });
    tmp.getTracks().forEach(t=>t.stop());
    alert('Permiso de cámara concedido. Ahora puedes iniciar.');
    await listCameras();
  }catch(e){
    log('getUserMedia error: '+(e && (e.name+': '+e.message)));
    alert('No fue posible solicitar permisos. Revisa HTTPS/localhost.');
  }
});
els.btnTogglePause.addEventListener('click', ()=>{
  SCAN_PAUSED = !SCAN_PAUSED;
  els.btnTogglePause.textContent = SCAN_PAUSED ? 'Reanudar escaneo' : 'Pausar escaneo';
  els.btnTogglePause.className = SCAN_PAUSED ? 'btn bg-blue-500 text-white' : 'btn bg-yellow-500 text-white';
  setStatusOk(SCAN_PAUSED ? 'PAUSADO' : 'EN ESCANEO');
});
els.btnCamStart.addEventListener('click', ()=>{ const engine = els.engineSelect.value; if (engine === 'bd') startBD(); else startQuagga(); });
els.btnCamStop.addEventListener('click', stopAll);
els.btnFullscreen.addEventListener('click', ()=>{ const el=document.documentElement; if(document.fullscreenElement) document.exitFullscreen(); else el.requestFullscreen?.(); });
els.btnTorch.addEventListener('click', async ()=>{
  try{
    if (!QUIRKS.track) return alert('Cámara no activa');
    const caps = QUIRKS.track.getCapabilities?.(); if(!caps || !caps.torch) return alert('Tu dispositivo no soporta linterna');
    QUIRKS.torchOn = !QUIRKS.torchOn;
    await QUIRKS.track.applyConstraints({advanced:[{torch: QUIRKS.torchOn}]});
  }catch(e){ alert('No fue posible activar la linterna'); }
});
async function startBD(){
  stopQuagga();
  if (!supportsBarcode) { alert('Barcode Detector no soportado. Usa Quagga2.'); return; }
  try{
    const devId = els.cameraSelect.value || undefined;
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: devId ? {exact: devId} : undefined, facingMode: devId? undefined : {ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    els.videoCam.srcObject = camStream;
    QUIRKS.track = camStream.getVideoTracks()[0] || null;
    runDetectLoop();
  }catch(e){ log('startBD error: '+(e && (e.name+': '+e.message))); alert('No se pudo iniciar BD. Prueba motor Quagga2.'); }
}
function stopBD(){ try{ camStream?.getTracks()?.forEach(t=>t.stop()); }catch(_){}
  camStream=null; QUIRKS.track=null; if(detectLoop) cancelAnimationFrame(detectLoop); detectLoop=null; }
function runDetectLoop(){
  const step = async () => {
    if(!camStream) return;
    try{
      if (SCAN_PAUSED) { detectLoop = requestAnimationFrame(step); return; }
      const ts=performance.now();
      if(!runDetectLoop._last || ts-runDetectLoop._last > 160){
        runDetectLoop._last = ts;
        const codes = await detector.detect(els.videoCam);
        if (codes && codes.length) {
          const raw = codes[0].rawValue?.trim();
          if (raw && canAccept(raw)) handleScannedRaw(raw);
        }
      }
    }catch(e){}
    detectLoop = requestAnimationFrame(step);
  };
  detectLoop = requestAnimationFrame(step);
}
function startQuagga(){
  stopBD();
  const readers = ["ean_reader","ean_8_reader","upc_reader","upc_e_reader","code_128_reader","code_39_reader","code_39_vin_reader","codabar_reader","i2of5_reader","2of5_reader"];
  const config = {
    inputStream: { type: "LiveStream", target: els.quaggaArea, constraints: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } },
    locator: { patchSize: "medium", halfSample: true },
    decoder: { readers }, locate: true,
    numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, navigator.hardwareConcurrency - 1) : 2
  };
  window.Quagga?.init(config, err => {
    if (err) { log("Quagga init error: "+err); alert("No se pudo iniciar Quagga."); return; }
    window.Quagga.start(); quaggaActive = true; overlayResize();
  });
  window.Quagga?.onDetected(onQuaggaDetected);
  window.Quagga?.onProcessed(drawQuaggaBoxes);
}
function stopQuagga(){ try { window.Quagga?.stop(); } catch(_) {} quaggaActive = false; clearOverlay(); }
function onQuaggaDetected(data){
  if (SCAN_PAUSED) return;
  const raw = data?.codeResult?.code?.trim();
  if (!raw) return;
  if (!canAccept(raw)) return;
  handleScannedRaw(raw);
}
function drawQuaggaBoxes(result){
  const ctx = document.getElementById('quaggaOverlay').getContext("2d");
  clearOverlay(); if (!result) return;
  const draw = (path, color, width=2) => { ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y); for (let i=1;i<path.length;i++) ctx.lineTo(path[i].x, path[i].y); ctx.lineTo(path[0].x, path[0].y); ctx.lineWidth = width; ctx.strokeStyle = color; ctx.stroke(); };
  if (result.boxes) result.boxes.filter(b=>b !== result.box).forEach(b => draw(b, "rgba(255,255,255,0.4)", 1));
  if (result.box) draw(result.box, "rgba(0,255,0,0.8)", 3);
}
function overlayResize(){ const rect = document.getElementById('quaggaArea').getBoundingClientRect(); const canvas = document.getElementById('quaggaOverlay'); canvas.width = rect.width; canvas.height = rect.height; }
function clearOverlay(){ const canvas = document.getElementById('quaggaOverlay'); const ctx = canvas.getContext("2d"); ctx.clearRect(0,0,canvas.width, canvas.height); }
window.addEventListener("resize", overlayResize);
function stopAll(){ stopBD(); stopQuagga(); }

/* ===== Registro (local + Firestore) ===== */
function handleScannedRaw(raw){
  const item = state.catalog.get(raw); // BC → datos
  if(item){
    const key = toKey(item.MOD,item.COLOR,item.TALLA);
    if (els.chkAuto.checked) registerKey(key);
    setStatusOk('OK: ' + raw); playOk();
    if (els.chkAutoReporte.checked) generateReport(true);
  }else{
    setStatusErr('NO EN CATÁLOGO: ' + raw);
    playErr(); buzz([80,40,80]);
    alert('Código NO encontrado en catálogo: ' + raw + '\n\nNo se registró. Verifica el catálogo o usa "Registrar manual".');
  }
}
function currentSession(){ return (els.metaNombre.value?.trim() || 'SESION_SIN_NOMBRE').toUpperCase(); }

async function registerKey(key){
  try{
    const ref = collection(db, 'conteos', currentSession(), 'eventos');
    const nonce = crypto.randomUUID?.() || (Date.now() + '_' + Math.random().toString(36).slice(2));
    processedNonces.add(nonce);
    await addDoc(ref, { t: serverTimestamp(), deviceId, key, nonce, operador: (els.metaOperador.value||'').trim() });
    els.diag.textContent = `Enviado → ${key}\n` + els.diag.textContent;
  }catch(e){
    state.scans.push(key);
    state.groupedScans = group(state.scans);
    refreshUI(); saveLocal();
    els.diag.textContent = `Local fallback → ${key} (${e?.message||e})\n` + els.diag.textContent;
  }
}
let unsubscribe = null;
function listenSession(){
  if (unsubscribe) { unsubscribe(); unsubscribe=null; }
  const ref = collection(db, 'conteos', currentSession(), 'eventos');
  const q = query(ref, orderBy('t', 'asc'), limit(5000));
  unsubscribe = onSnapshot(q, snap=>{
    let changed = false;
    const feedRows = [];
    snap.forEach(doc=>{
      const d = doc.data();
      const key = d.key;
      const op = d.operador || '';
      const dev = (d.deviceId || '').slice(0,6);
      const when = d.t?.toDate?.() ? d.t.toDate() : null;
      const hh = when ? when.toLocaleTimeString() : '—';
      feedRows.push(`<tr><td>${hh}</td><td>${key||''}</td><td>${op}</td><td>${dev}</td></tr>`);
    });
    els.liveFeedBody.innerHTML = feedRows.reverse().slice(0,200).join('');
    snap.docChanges().forEach(ch=>{
      if (ch.type === 'added') {
        const data = ch.doc.data();
        const { key, nonce } = data || {};
        if (!key) return;
        if (nonce && processedNonces.has(nonce)) { processedNonces.delete(nonce); return; }
        state.scans.push(key);
        changed = true;
      }
    });
    if (changed) { state.groupedScans = group(state.scans); refreshUI(); saveLocal(); if (els.chkAutoReporte.checked) generateReport(true); }
  });
}
els.metaNombre.addEventListener('change', listenSession);

/* ===== Reporte ===== */
const filtros = { MOD: document.getElementById('filtroMOD'), COLOR: document.getElementById('filtroCOLOR'), TALLA: document.getElementById('filtroTALLA'), TEMP: document.getElementById('filtroTEMP') };
function keyPassesFilters(key){ const [MOD,COLOR,TALLA]=key.split('|'); const TEMP=(state.keyMeta.get(key)?.TEMPORADA||'').toUpperCase();
  if(filtros.MOD.value && !MOD.toUpperCase().includes(filtros.MOD.value.toUpperCase())) return false;
  if(filtros.COLOR.value && !COLOR.toUpperCase().includes(filtros.COLOR.value.toUpperCase())) return false;
  if(filtros.TALLA.value && !TALLA.toUpperCase().includes(filtros.TALLA.value.toUpperCase())) return false;
  if(filtros.TEMP.value && !TEMP.includes(filtros.TEMP.value.toUpperCase())) return false;
  return true;
}
Object.values(filtros).forEach(inp=>inp.addEventListener('input',()=>generateReport(true)));
function generateReport(skipScroll){
  const esc=state.groupedScans, exi=state.existencia, sobr=new Map(), falt=new Map(), escT=new Map();
  const keys=new Set([...esc.keys(),...exi.keys()]);
  for(const k of keys){
    if(!keyPassesFilters(k)) continue;
    const e=esc.get(k)||0, x=exi.get(k)||0;
    if(e>0) escT.set(k,e); if(e-x>0) sobr.set(k,e-x); if(x-e>0) falt.set(k,x-e);
  }
  els.tablaEscaneados.innerHTML=renderTable(escT,['Clave','Escaneado']);
  els.tablaSobrantes.innerHTML=renderTable(sobr,['Clave','Sobrante']);
  els.tablaFaltantes.innerHTML=renderTable(falt,['Clave','Faltante']);
  if(!skipScroll) document.getElementById('tab-reporte').scrollIntoView({behavior:'smooth'});
  return {escT,sobr,falt};
}
els.btnGenerarReporte.addEventListener('click',()=>generateReport());
els.btnExportarCSV.addEventListener('click',()=>{ const {escT,sobr,falt}=generateReport(true); exportCSV([['ESCANEADOS',escT],['SOBRANTES',sobr],['FALTANTES',falt]]); });
els.btnRespaldarJSON.addEventListener('click',()=>{ const d={catalog:[...state.catalog], indexByKey:[...state.indexByKey], keyMeta:[...state.keyMeta], existencia:[...state.existencia], scans:state.scans, v:'hist-fb-v2'}; const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='respaldo_conteo_cklass.json'; a.click(); URL.revokeObjectURL(url); });

/* ===== Historial local ===== */
function loadHist(){ try{ return JSON.parse(localStorage.getItem('conteo_cklass_hist')||'[]'); }catch(_){ return []; } }
function saveHist(list){ localStorage.setItem('conteo_cklass_hist', JSON.stringify(list)); }
function makeSnapshot(){
  const nombre = els.metaNombre.value?.trim() || '(sin nombre)';
  const operador = els.metaOperador.value?.trim() || '(sin operador)';
  const notas = els.metaNotas.value?.trim() || '';
  const when = new Date();
  return {
    id: crypto.randomUUID?.() || String(when.getTime())+'_'+Math.random().toString(36).slice(2),
    nombre, operador, notas,
    fechaIso: when.toISOString(), fechaLocal: when.toLocaleString(), deviceId,
    existencia: [...state.existencia], scans: state.scans.slice(), groupedScans: [...state.groupedScans],
    totals: { escaneados: state.scans.length, claves: state.groupedScans.size, existenciaClaves: state.existencia.size }
  };
}
function renderHist(){
  const list = loadHist();
  if(!list.length){ els.histList.innerHTML = '<div class="p-3 text-sm text-gray-600">No hay conteos guardados.</div>'; return; }
  const rows = list.slice().reverse().map(h=>`
    <tr>
      <td class="px-2 py-2 border-b">${h.fechaLocal}</td>
      <td class="px-2 py-2 border-b font-medium">${h.nombre}</td>
      <td class="px-2 py-2 border-b">${h.operador}</td>
      <td class="px-2 py-2 border-b text-xs">${h.notas||''}</td>
      <td class="px-2 py-2 border-b text-right">${h.totals?.escaneados||0}</td>
      <td class="px-2 py-2 border-b text-right">${h.totals?.claves||0}</td>
      <td class="px-2 py-2 border-b">
        <div class="flex flex-wrap gap-2">
          <button class="btn bg-blue-600 text-white" onclick="reabrirHist('${h.id}')">Reabrir</button>
          <button class="btn bg-gray-100" onclick="exportHistCSV('${h.id}')">CSV</button>
          <button class="btn bg-gray-100" onclick="exportHistJSON('${h.id}')">JSON</button>
          <button class="btn bg-red-600 text-white" onclick="borrarHist('${h.id}')">Eliminar</button>
        </div>
      </td>
    </tr>`).join('');
  els.histList.innerHTML = `<table class="min-w-full text-sm table">
    <thead><tr>
      <th class="text-left">Fecha</th>
      <th class="text-left">Nombre</th>
      <th class="text-left">Operador</th>
      <th class="text-left">Notas</th>
      <th class="text-right">Escaneos</th>
      <th class="text-right">Claves</th>
      <th class="text-left">Acciones</th>
    </tr></thead><tbody>${rows}</tbody></table>`;
}
window.reabrirHist = function(id){
  const list = loadHist();
  const h = list.find(x=>x.id===id); if(!h) return alert('No encontrado');
  state.existencia = new Map(h.existencia||[]);
  state.scans = h.scans||[];
  state.groupedScans = new Map(h.groupedScans||[]);
  refreshUI();
  setStatusOk('Cargado desde histórico');
  document.querySelector('[data-tab="escanear"]').click();
};
window.exportHistJSON = function(id){
  const list=loadHist(); const h=list.find(x=>x.id===id); if(!h) return;
  const blob=new Blob([JSON.stringify(h,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`conteo_${(h.nombre||'sin_nombre')}.json`; a.click(); URL.revokeObjectURL(url);
};
window.exportHistCSV = function(id){
  const list=loadHist(); const h=list.find(x=>x.id===id); if(!h) return;
  exportCSV([['ESCANEADOS', new Map(h.groupedScans||[])], ['EXISTENCIA', new Map(h.existencia||[])]]);
};
window.borrarHist = function(id){
  const list = loadHist(); const i=list.findIndex(x=>x.id===id); if(i<0) return;
  if(!confirm('¿Eliminar conteo del historial?')) return;
  list.splice(i,1); saveHist(list); renderHist();
};
els.btnGuardarHistorico.addEventListener('click', ()=>{
  if (!state.scans.length && !state.existencia.size) { if(!confirm('No hay datos en este conteo. ¿Guardar de todos modos?')) return; }
  const snap = makeSnapshot();
  const list = loadHist(); list.push(snap); saveHist(list);
  renderHist(); setStatusOk('Guardado en histórico'); alert('Conteo guardado en histórico.\n\nPestaña 4) Historial.');
});
els.btnNuevaSesion.addEventListener('click', ()=>{
  if(!confirm('Esto limpia escaneos y existencia (no el catálogo). ¿Continuar?')) return;
  state.scans = []; state.groupedScans.clear(); state.existencia.clear();
  els.existenciaPreview.innerHTML=''; els.existenciaStatus.textContent='0 registros.';
  els.scanLog.innerHTML=''; els.scanGrouped.innerHTML='';
  saveLocal(); setStatusOk('Sesión nueva lista');
});

/* ===== Init ===== */
function init(){
  loadLocal();
  refreshUI();
  listCameras();
  renderHist();
  listenSession();
  loadPersistedCatalog();
  bootFromFolioParam();           // ← si viene ?folio=... lo carga solo
}
init();
</script>
</body>
</html>
