<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conteo Cíclico CKLASS</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .btn{padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem}
  .card{background:#fff;border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:1rem}
  .table th,.table td{border-bottom:1px solid #e5e7eb;padding:.25rem .5rem}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  @media print {.no-print{display:none!important}}
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-4">
  <header class="mb-4 no-print">
    <h1 class="text-2xl font-bold">Conteo Cíclico — Firestore + Sheets</h1>
    <p class="text-sm text-gray-600">Catálogo en Firestore (vía Google Sheets). Multi‑dispositivo. Históricos. Cámara y reportes con “compensados”.</p>
  </header>

  <!-- Salud + LOG -->
  <div class="card no-print mb-4">
    <div class="flex items-center justify-between">
      <div class="flex gap-3 text-sm">
        <span id="authBadge">Auth: —</span>
        <span id="connBadge">Conexión: —</span>
        <span id="catBadge">Catálogo: —</span>
      </div>
      <div class="flex gap-2">
        <button id="btnCopyLog" class="btn bg-gray-100">Copiar log</button>
        <button id="btnClearLog" class="btn bg-gray-100">Limpiar log</button>
      </div>
    </div>
    <div id="uiLog" class="mono text-xs bg-gray-50 rounded-lg p-2 h-28 overflow-auto border mt-2"></div>
  </div>

  <!-- Tabs -->
  <div class="border-b border-gray-200 mb-4 no-print">
    <nav class="-mb-px flex gap-2">
      <button data-tab="folio" class="tab btn border-b-2 border-blue-600 text-blue-600">1) Folio</button>
      <button data-tab="escanear" class="tab btn border-b-2 border-transparent">2) Escanear</button>
      <button data-tab="existencia" class="tab btn border-b-2 border-transparent">3) Existencia</button>
      <button data-tab="reporte" class="tab btn border-b-2 border-transparent">4) Reporte</button>
      <button data-tab="historial" class="tab btn border-b-2 border-transparent">5) Historial</button>
    </nav>
  </div>

  <!-- Folio -->
  <section id="tab-folio" class="card">
    <h2 class="font-semibold mb-2">Folio (Firestore)</h2>
    <div class="grid md:grid-cols-6 gap-2">
      <select id="selAlmacen" class="rounded-lg border border-gray-200 p-2 text-sm">
        <option value="CAL">Calzado (C)</option>
        <option value="ROP">Ropa (R)</option>
        <option value="SPO">Sport (S)</option>
        <option value="GLO">Global (G)</option>
      </select>
      <input id="sucursalInput" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Sucursal (impresa en reporte)" />
      <input id="folioInput" class="rounded-lg border border-gray-200 p-2 text-sm" placeholder="Vacío = generar automático" />
      <button id="btnGenerarFolio" class="btn bg-gray-200">Generar folio</button>
      <button id="btnUsarFolio" class="btn bg-blue-600 text-white">Usar folio</button>
      <button id="btnCerrarFolio" class="btn bg-rose-600 text-white">Cerrar folio</button>
    </div>
    <p class="text-xs text-gray-600 mt-2">Formato: <b>C1/R1/S1/G1</b> (transacción segura). Mismo folio en varios dispositivos = acumulado global.</p>
    <div id="folioStatus" class="text-xs text-gray-600 mt-1">—</div>

    <div class="mt-4">
      <h3 class="font-semibold mb-2">Acumulado del folio (en vivo)</h3>
      <div id="scanGrouped" class="overflow-auto max-h-72 border rounded-xl p-2 text-sm">Sin folio activo.</div>
    </div>
  </section>

  <!-- Escanear -->
  <section id="tab-escanear" class="card hidden">
    <h2 class="font-semibold mb-2">Escaneo</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-semibold mb-2">Lector / Manual</h3>
        <input id="scanInput" class="w-full rounded-xl border border-gray-200 p-3 mb-2" placeholder="EAN / Código de barras (Enter)" />
        <div class="text-xs text-gray-500">Tip: con lector USB basta enfocar y presionar.</div>

        <h3 class="font-semibold mt-4 mb-2">Cámara</h3>
        <div class="flex gap-2">
          <button id="btnCamStart" class="btn bg-green-600 text-white">Iniciar cámara</button>
          <button id="btnCamStop" class="btn bg-gray-200">Detener</button>
        </div>
        <video id="video" class="w-full rounded-lg mt-2 bg-black" autoplay playsinline muted style="max-height:320px"></video>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Clave resuelta</h3>
        <div id="lastResolve" class="border rounded-xl p-3 text-sm bg-gray-50">—</div>
        <h3 class="font-semibold mt-4 mb-2">Últimos escaneos</h3>
        <div id="scanLog" class="overflow-auto max-h-64 border rounded-xl p-2 text-sm"></div>
      </div>
    </div>
  </section>

  <!-- Existencia -->
  <section id="tab-existencia" class="card hidden">
    <h2 class="font-semibold mb-2">Existencia (pegar)</h2>
    <p class="text-xs text-gray-600 mb-2">Formato único: <code>MOD|COLOR|TALLA[,CANT]</code> · Ej: <code>500-10|AZUL|M,10</code></p>
    <textarea id="existenciaInput" rows="6" class="w-full rounded-xl border border-gray-200 p-2 text-sm"></textarea>
    <div class="flex gap-2 mt-2">
      <button id="btnProcesarExistencia" class="btn bg-blue-600 text-white">Procesar</button>
      <button id="btnLimpiarExistencia" class="btn bg-gray-100">Limpiar</button>
    </div>
    <div class="text-xs text-gray-600 mt-2" id="existenciaStatus">0 claves.</div>
  </section>

  <!-- Reporte -->
  <section id="tab-reporte" class="card hidden">
    <h2 class="font-semibold mb-2">Reporte</h2>

    <!-- Encabezado Reporte (impreso) -->
    <div id="reportHeader" class="border rounded-xl p-3 mb-3">
      <div class="flex items-center gap-4">
        <img id="hdrLogo" src="" alt="Logo" style="height:48px;width:auto;" />
        <div>
          <div class="text-lg font-semibold">Conteo Cíclico CKlass</div>
          <div class="text-xs text-gray-500">Folio activo y resumen de diferencias</div>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-6 text-sm mt-2">
        <div><b>Folio:</b> <span id="hdrFolio">—</span></div>
        <div><b>Almacén:</b> <span id="hdrAlmacen">—</span></div>
        <div><b>Sucursal:</b> <span id="hdrSucursal">—</span></div>
        <div><b>Fecha:</b> <span id="hdrFecha">—</span></div>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 items-center no-print mb-3">
      <button id="btnGenerarReporte" class="btn bg-blue-600 text-white">Generar</button>
      <button id="btnExportarCSV" class="btn bg-gray-100">Exportar CSV</button>
      <!-- Botones de impresión -->
      <button id="btnPrintTodo" class="btn bg-emerald-600 text-white">Imprimir Todo</button>
      <button id="btnPrintFalt" class="btn bg-emerald-600 text-white">Imprimir Faltantes</button>
      <button id="btnPrintSobr" class="btn bg-emerald-600 text-white">Imprimir Sobrantes</button>
      <button id="btnPrintComp" class="btn bg-emerald-600 text-white">Imprimir Compensados</button>
    </div>

    <div id="bloquesReporte" class="grid md:grid-cols-3 gap-4">
      <div class="border rounded-xl p-3" data-block="escaneados">
        <h3 class="font-semibold mb-2">Escaneados (folio)</h3>
        <div id="tablaEscaneados" class="overflow-auto max-h-80"></div>
      </div>
      <div class="border rounded-xl p-3" data-block="sobrantes">
        <h3 class="font-semibold mb-2">Sobrantes</h3>
        <div id="tablaSobrantes" class="overflow-auto max-h-80"></div>
      </div>
      <div class="border rounded-xl p-3" data-block="faltantes">
        <h3 class="font-semibold mb-2">Faltantes</h3>
        <div id="tablaFaltantes" class="overflow-auto max-h-80"></div>
      </div>
    </div>

    <div class="border rounded-xl p-3 mt-4" data-block="compensados">
      <h3 class="font-semibold mb-2">Compensados (por MOD|COLOR)</h3>
      <div id="tablaComp" class="overflow-auto max-h-80"></div>
    </div>
  </section>

  <!-- Historial -->
  <section id="tab-historial" class="card hidden">
    <h2 class="font-semibold mb-2">Historial de folios</h2>
    <div id="histList" class="text-sm">—</div>
  </section>
</div>

<script type="module">
/* ===== Config identidad ===== */
const LOGO_URL = 'icons/logo.png'; // cambia si usas otra ruta

/* ===== Utils & UI ===== */
const $=s=>document.querySelector(s), el=id=>document.getElementById(id);
const logBox=el('uiLog'); const setText=(id,t)=>el(id).textContent=t;
function log(...args){ const t=new Date().toLocaleTimeString(); logBox.textContent+=`[${t}] ${args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ')}\n`; logBox.scrollTop=logBox.scrollHeight; }
el('btnClearLog').onclick=()=>logBox.textContent='';
el('btnCopyLog').onclick=()=>navigator.clipboard.writeText(logBox.textContent||'');
const canon=s=>(s==null?'':String(s)).normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toUpperCase();
function mapTable(map){
  const rows=[...map.entries()].map(([k,v])=>`<tr><td class="px-2">${k}</td><td class="px-2 text-right">${v}</td></tr>`).join('');
  return `<table class="min-w-full text-sm table"><tbody>${rows||'<tr><td class="px-2 text-gray-400">—</td><td></td></tr>'}</tbody></table>`;
}
function showTab(name){ document.querySelectorAll('.tab').forEach(b=>{ const on=b.dataset.tab===name; b.classList.toggle('text-blue-600',on); b.classList.toggle('border-blue-600',on); }); document.querySelectorAll('section.card').forEach(s=>s.classList.add('hidden')); el('tab-'+name).classList.remove('hidden'); location.hash='#'+name; }
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>showTab(b.dataset.tab)); showTab((location.hash||'#folio').slice(1));

/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, getDocs,
  serverTimestamp, runTransaction, onSnapshot, increment,
  query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCPMrGQRCeCWJazNE1rX_etVzb_hmvknDI",
  authDomain: "conteo-ciclico-ac53d.firebaseapp.com",
  projectId: "conteo-ciclico-ac53d",
  storageBucket: "conteo-ciclico-ac53d.firebasestorage.app",
  messagingSenderId: "726286668974",
  appId: "1:726286668974:web:64bacbef748d759540093f",
  measurementId: "G-6C6SB2LTSZ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const app=initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
onAuthStateChanged(auth,u=>{ setText('authBadge', u?`Auth: OK (${u.uid.slice(0,6)}…)`:'Auth: —'); });
signInAnonymously(auth).catch(e=>log('Auth anon ERROR:', e?.message||e));
setText('connBadge', navigator.onLine?'Conexión: online':'Conexión: offline'); addEventListener('online',()=>setText('connBadge','Conexión: online')); addEventListener('offline',()=>setText('connBadge','Conexión: offline'));

/* ===== Estado ===== */
const state={ folio:'', almacen:'', sucursal:'', unsub:null, acumulado:new Map(), existencia:new Map(), lastEAN:'', cam:null, detector:null };

/* Ayuda nombres bonitos */
const ALM_NOMBRE = { CAL:'Calzado', ROP:'Ropa', SPO:'Sport', GLO:'Global' };

/* ===== Folios (C/R/S/G) ===== */
const PREF={CAL:'C', ROP:'R', SPO:'S', GLO:'G'};
async function generarFolioTx(){
  const pref=PREF[el('selAlmacen').value]||'G';
  const ref=doc(db,'counters','folios',pref);
  const num=await runTransaction(db, async tx=>{
    const snap=await tx.get(ref); if(!snap.exists()) throw new Error(`Falta counters/folios/${pref}`);
    const next=(snap.data().next||1); tx.update(ref,{next:next+1}); return next;
  });
  return `${pref}${num}`;
}
function subAcumulado(f){
  if(state.unsub){ state.unsub(); state.unsub=null; }
  if(!f){ el('scanGrouped').innerHTML='Sin folio activo.'; return; }
  const col=collection(db,'ciclicos',f,'acumulado');
  state.unsub=onSnapshot(col,(qs)=>{
    const m=new Map(); qs.forEach(d=>m.set(d.id, (d.data()?.qty)||0));
    state.acumulado=m; el('scanGrouped').innerHTML=mapTable(m); setText('catBadge', 'Catálogo: listo');
  }, err=>log('onSnapshot ERROR', err?.message||err));
}

/* Encabezado Reporte */
function updateReportHeader(){
  el('hdrLogo').src = LOGO_URL;
  el('hdrFolio').textContent = state.folio || '—';
  el('hdrAlmacen').textContent = ALM_NOMBRE[state.almacen] || state.almacen || '—';
  el('hdrSucursal').textContent = state.sucursal || '—';
  el('hdrFecha').textContent = new Date().toLocaleString();
}

el('btnGenerarFolio').onclick=async()=>{
  try{ const f=await generarFolioTx(); el('folioInput').value=f; setText('folioStatus','Folio generado: '+f); log('Folio generado', f); }
  catch(e){ alert('No se pudo generar folio: '+(e?.message||e)); }
};
el('btnUsarFolio').onclick=async()=>{
  const f=(el('folioInput').value||'').trim(); if(!f) return alert('Escribe o genera un folio.');
  const almacenSel = el('selAlmacen').value;
  const suc=el('sucursalInput').value.trim();
  state.folio=f; state.almacen=almacenSel; state.sucursal=suc;
  await setDoc(doc(db,'ciclicos',f),{
    folio:f, almacen:almacenSel, sucursal:suc || null, status:'abierto', ts:serverTimestamp()
  },{merge:true});
  setText('folioStatus','Folio activo: '+f);
  subAcumulado(f); log('Folio activo', f);
  updateReportHeader();
};
el('btnCerrarFolio').onclick=async()=>{
  if(!state.folio) return alert('Activa un folio primero.');
  await setDoc(doc(db,'ciclicos',state.folio),{status:'cerrado', closedAt:serverTimestamp()},{merge:true});
  alert('Folio cerrado: '+state.folio);
  updateReportHeader();
};

/* ===== Escaneo (manual + cámara) ===== */
function pushScan(s){ const box=el('scanLog'); const t=new Date().toLocaleTimeString(); box.innerHTML=`<div>${t} · ${s}</div>`+box.innerHTML; box.innerHTML=box.innerHTML.split('</div>').slice(0,60).join('</div>'); }
async function resolverEAN(ean){
  const snap=await getDoc(doc(db,'barcodes',ean));
  if(!snap.exists()) return null;
  const {MOD='',COLOR='',TALLA=''}=snap.data()||{};
  return {MOD,COLOR,TALLA};
}
async function addScanByEAN(ean){
  if(!state.folio) return pushScan(`${ean} · sin folio`);
  try{
    const info=await resolverEAN(ean);
    if(!info){ el('lastResolve').innerHTML=`<span class="text-red-600">No en catálogo:</span> ${ean}`; pushScan(`${ean} · no catálogo`); return; }
    const clave=`${canon(info.MOD)}|${canon(info.COLOR)}|${canon(info.TALLA)}`;
    await setDoc(doc(db,'ciclicos',state.folio,'acumulado',clave),{
      qty:increment(1), MOD:info.MOD, COLOR:info.COLOR, TALLA:info.TALLA, updatedAt:serverTimestamp()
    },{merge:true});
    el('lastResolve').innerHTML=`<b>${clave}</b><div class="text-xs text-gray-600">${info.MOD} / ${info.COLOR} / ${info.TALLA}</div>`;
    pushScan(`${ean} → ${clave} (+1)`);
  }catch(e){ pushScan(`${ean} · ERROR ${e?.message||e}`); }
}
el('scanInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){ const v=e.target.value.trim(); e.target.value=''; if(v) addScanByEAN(v); }
});

/* Cámara con BarcodeDetector */
async function camStart(){
  if(!('BarcodeDetector' in window)) { alert('Tu navegador no soporta BarcodeDetector. Usa lector USB o Chrome/Android.'); return; }
  state.detector=new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128'] });
  state.cam=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
  const v=el('video'); v.srcObject=state.cam; await v.play();
  let lock=false;
  const tick=async()=>{
    if(!state.cam) return;
    try{
      if(!lock){ lock=true;
        const det=await state.detector.detect(v);
        if(det && det[0]){
          const code=(det[0].rawValue||'').trim();
          if(code && code!==state.lastEAN){ state.lastEAN=code; addScanByEAN(code); }
        }
        lock=false;
      }
    }catch{ lock=false; }
    requestAnimationFrame(tick);
  };
  tick();
}
function camStop(){ if(state.cam){ state.cam.getTracks().forEach(t=>t.stop()); state.cam=null; } }
el('btnCamStart').onclick=camStart; el('btnCamStop').onclick=camStop;

/* ===== Existencia (formato único) ===== */
function parseExist(text){
  const lines=(text||'').replace(/\uFEFF/g,'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const acc=new Map(); let ok=0, skip=0;
  for(const l of lines){
    const m=l.match(/^([^|]+)\|([^|]+)\|([^|,]+)(?:\s*,\s*(\d+))?$/);
    if(!m){ skip++; continue; }
    const key=`${canon(m[1])}|${canon(m[2])}|${canon(m[3])}`;
    const qty=parseInt(m[4]||'1',10)||1;
    acc.set(key,(acc.get(key)||0)+qty); ok++;
  }
  state.existencia=acc; setText('existenciaStatus', `${acc.size} claves. (${ok} filas válidas; omitidas ${skip})`);
}
el('btnProcesarExistencia').onclick=()=>{ const raw=el('existenciaInput').value||''; if(!raw.trim()) return alert('No hay texto.'); parseExist(raw); };
el('btnLimpiarExistencia').onclick=()=>{ el('existenciaInput').value=''; state.existencia=new Map(); setText('existenciaStatus','0 claves.'); };

/* ===== Reporte + Compensados + Export ===== */
function render(containerId, map){ el(containerId).innerHTML=mapTable(map); }
function computeSobrantes(acum, ex){ const m=new Map(); for(const [k,qty] of acum.entries()){ const e=ex.get(k)||0; if(qty>e) m.set(k, qty-e); } return m; }
function computeFaltantes(acum, ex){ const m=new Map(); for(const [k,e] of ex.entries()){ const q=acum.get(k)||0; if(e>q) m.set(k, e-q); } return m; }
function computeCompensados(acum, ex){
  const group = new Map(); // key2 = MOD|COLOR
  const add = (k, delta)=>{ const [m,c]=k.split('|'); const key2=`${m}|${c}`; group.set(key2, (group.get(key2)||0)+delta); };
  for(const [k,qe] of acum.entries()){ const e=ex.get(k)||0; add(k, qe - e); }
  for(const [k,e] of ex.entries()){ if(!acum.has(k)) add(k, 0 - e); }
  const res=new Map();
  for(const [key2,net] of group.entries()){
    if(net>0) res.set(key2+'|SOB', net);
    else if(net<0) res.set(key2+'|FAL', Math.abs(net));
  }
  return res;
}
function exportCSV(rows){
  if(!rows.length) return '';
  const headers=Object.keys(rows[0]); const esc=v=>('"'+String(v??'').replace(/"/g,'""')+'"');
  return [headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
}
el('btnGenerarReporte').onclick=()=>{
  if(!state.folio) return alert('Activa un folio');
  updateReportHeader();
  render('tablaEscaneados', state.acumulado);
  const sobr=computeSobrantes(state.acumulado, state.existencia);
  const falt=computeFaltantes(state.acumulado, state.existencia);
  render('tablaSobrantes', sobr); render('tablaFaltantes', falt);
  const comp=computeCompensados(state.acumulado, state.existencia);
  render('tablaComp', comp);
};
el('btnExportarCSV').onclick=()=>{
  const rows=[]; const push=(tipo,map)=>{ for(const [k,v] of map.entries()) rows.push({
    FOLIO: state.folio || '',
    ALMACEN: (ALM_NOMBRE[state.almacen]||state.almacen||''),
    SUCURSAL: state.sucursal || '',
    TIPO:tipo, CLAVE:k, QTY:v
  }); };
  push('ESCANEADOS',state.acumulado);
  const sobr=computeSobrantes(state.acumulado, state.existencia); push('SOBRANTES',sobr);
  const falt=computeFaltantes(state.acumulado, state.existencia); push('FALTANTES',falt);
  const comp=computeCompensados(state.acumulado, state.existencia); push('COMPENSADOS',comp);
  const csv=exportCSV(rows);
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`reporte_${state.folio||'SIN_FOLIO'}.csv`; a.click(); URL.revokeObjectURL(a.href);
};

/* ===== Impresión (4 botones) ===== */
function printBlocks(only){
  const blocks=document.querySelectorAll('[data-block]');
  blocks.forEach(b=>{
    const ok = only==='todo' ? true : b.getAttribute('data-block')===only;
    b.style.display = ok ? 'block' : 'none';
  });
  window.print();
  blocks.forEach(b=>b.style.display='block');
}
el('btnPrintTodo').onclick = ()=>{ updateReportHeader(); printBlocks('todo'); };
el('btnPrintFalt').onclick = ()=>{ updateReportHeader(); printBlocks('faltantes'); };
el('btnPrintSobr').onclick = ()=>{ updateReportHeader(); printBlocks('sobrantes'); };
el('btnPrintComp').onclick = ()=>{ updateReportHeader(); printBlocks('compensados'); };

/* ===== Historial (últimos folios) ===== */
async function loadHist(){
  const q=query(collection(db,'ciclicos'), orderBy('ts','desc'), limit(30));
  const snap=await getDocs(q);
  const rows=[]; snap.forEach(d=>{ const x=d.data()||{}; rows.push({ id:d.id, almacen:x.almacen||'-', sucursal:x.sucursal||'-', status:x.status||'-', ts:x.ts?.toDate?.()?.toLocaleString?.()||'-' }); });
  el('histList').innerHTML = rows.map(r=>`
    <div class="flex items-center justify-between border-b py-1">
      <div><b>${r.id}</b> · ${r.almacen} · ${r.sucursal} · ${r.status} · ${r.ts}</div>
      <div class="flex gap-2">
        <button class="btn bg-blue-600 text-white" onclick="folioAbrir('${r.id}','${r.almacen}','${(r.sucursal||'').replace(/'/g,'\\\'')}')">Abrir</button>
      </div>
    </div>
  `).join('') || '—';
}
window.folioAbrir = async (id, alm, suc)=>{
  el('folioInput').value=id;
  if(alm){ state.almacen=alm; }
  if(suc){ state.sucursal=suc; el('sucursalInput').value=suc; }
  el('btnUsarFolio').click(); showTab('reporte');
};

/* ===== Arranque ===== */
addEventListener('DOMContentLoaded', ()=>{
  log('App lista.');
  el('hdrLogo').src = LOGO_URL;
  const p=new URLSearchParams(location.search);
  if(p.has('folio')){ el('folioInput').value=p.get('folio'); el('btnUsarFolio').click(); }
  loadHist();
});
</script>
</body>
</html>
